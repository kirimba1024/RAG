- SG: автопровижининг (admin, repos, autoindex), src-cli в образе, repos init вручную.
- .env: добавлены SOURCEGRAPH_ADMIN_*, PROVISION_REPOS=1; .gitignore позволяет .env.
- Репозитории: работаем из repos/, отказ от knowledge/; REPOS_ROOT вместо KNOWLEDGE_ROOT.
- Sandbox: монтируем repos → /app, добавлен git, обновлены сообщения entrypoint.
- Sourcegraph tools: sg_search/sg_codeintel/sg_blob упрощены; добавлены sg_get_file_content, sg_list_repos, sg_list_repo_files, sg_file_chunks (символы→чанки, fallback по строкам).
- Индексация ES (build.py): полностью через SG+SCIP чанки; хэш по контенту SG; дифф манифеста против actual из SG; удаление из ES по удалённым; маскировка секретов и лог находок; ignore на уровне файла.
- Упрощение build.py: удалены ридеры/try-except/старые сплиттеры; чистый пайплайн SG→ES.
- GraphRAG: вынесен в graphrag_build.py; build.py больше не вызывает пересборку.
- tools.py: упрощён, graphrag_query без обёрток, REPOS_ROOT напрямую.
- Промпты: chat_system_gather.txt — добавлен git в список утилит.
- Прочее: удалён PROP_GRAPH_INDEX; удалены сканы по всему дереву из check.py; mask.py теперь предоставляет mask_secrets для текста.
- Рефакторинг utils.py: перенесён весь код из ignore.py (is_ignored, IGNORE_SPEC) и check.py (check_secrets_in_text, classify_secret_type, EMOJI_MAP) в utils.py для централизации утилит; удалены файлы ignore.py и check.py.
- Упрощение utils.py: удалены проверки существования REPOS_ROOT и IGNORE_FILE (правило "не страхуйся"), создан глобальный logger для utils вместо создания внутри функций; все импорты вынесены в глобальные (убраны локальные import hashlib и from mask import).
- Исправление по .cursorrules: удалены страховки от граничных случаев (if not text в clean_text), удалены комментарии (# Sourcegraph), все импорты только глобальные.

- Ветки (rev) в индексации: добавлено поле rev в manifest ES и metadata каждого чанка; функция sg_get_repo_rev получает текущую ветку из Sourcegraph; логика синхронизации сравнивает hash и rev - при изменении rev добавляются новые чанки, старые не удаляются; хранятся все ветки всех репозиториев.
- Фильтрация по веткам: retriever.py фильтрует чанки по metadata.rev при поиске; если rev не указан, определяется из path_prefix или первого репозитория; main_search требует обязательный параметр rev в схеме tools.
- Список веток в промптах: добавлены функции get_all_repos_branches и get_all_repos_branches_formatted в sourcegraph.py; список веток всех репозиториев автоматически вставляется в navigation промпт через placeholder {BRANCHES_INFO}; компактный формат (первые 10 веток, остальные +N).
- Бинарные файлы: sg_get_file_content возвращает None для бинарных файлов; добавлена extract_binary_content с поддержкой PDF/DOCX/PPTX/CSV/XLS/изображений через OCR (pytesseract); бинарные файлы создают один чанк с обрезкой до 4096 символов, kind="binary".
- Упрощения: убрана лишняя проверка content в calc_hash; функция sg_list_repo_branches удалена, логика встроена в get_all_repos_branches.
- Переименование rev→branch: все упоминания rev переименованы в branch во всех файлах (build.py, retriever.py, tools.py, chat.py, sourcegraph.py, manifest.json); branch теперь явно означает ветку Git, а не коммит SHA; функция sg_get_repo_rev переименована в sg_get_repo_branch и читает текущую ветку из локального .git/HEAD.
- Обязательный параметр branch: все инструменты (main_search, sg_search, sg_codeintel, sg_blob) требуют обязательный параметр branch; удалены дефолтные значения для branch, path_prefix, top_n; TOOLS_SCHEMA помечает все параметры как required с описаниями ожидаемых значений.
- Централизация обработки файлов: вся логика извлечения контента, чанкинга и санитизации перенесена в sourcegraph.py; создана функция get_file_chunks которая обрабатывает бинарные и текстовые файлы единообразно; функция get_file_hash получает hash напрямую из Sourcegraph oid без fallback на контент.
- Обработка бинарных файлов: бинарные файлы теперь дробятся на чанки через custom_split вместо одного чанка на 4096 символов; _extract_binary_content загружает файлы из Sourcegraph напрямую в память (BytesIO) без сохранения на диск; удалены все страховки и try-except блоки из _extract_binary_content согласно .cursorrules.
- Упрощение метаданных чанков: удалены поля symbol и kind из метаданных чанков в ES (оставлены только doc_id, start_line, end_line, chunk_id, chunk_total, branch); убрана функция _create_chunk, её логика встроена в _split_by_symbols и custom_split.
- Упрощение build.py: удалена неиспользуемая функция delete_file; логика process_files упрощена с прямыми вызовами delete_chunks и delete_manifest; добавлены try-except блоки для обработки ошибок отдельных файлов без остановки всего процесса; функция process_file выделена для обработки одного файла.
- Упрощение sourcegraph.py: убраны все избыточные проверки и страховки (.get() заменены на прямое обращение, убраны min/max для line numbers, удалены проверки if not content); удалены параметры doc_id и line из sg_codeintel; doc_id переименован в rel_path в sg_blob; все функции используют rel_path вместо раздельных repo/path где возможно.

- Переход на минималистичную индексацию одной ветки: удалён аргумент branch из всех инструментов (main_search, sg_search, sg_codeintel, sg_blob, code_stats); Sourcegraph API всегда использует HEAD; манифест ES хранит только rel_path и hash (без branch); удалены все упоминания архитектурной статистики; скрипт sg_get_repo_branch перенесён в utils.py, затем удалён (заменён на "HEAD").
- Оптимизация sg_list_repo_files: заменён N+1 GraphQL-запросов на единую команду git ls-tree -r HEAD для получения всех файлов с OID за один вызов; используется git_blob_oid из utils.py вместо SHA256 для соответствия Sourcegraph.
- Стандартизация фильтрации: sg_search и sg_codeintel используют path_prefix вместо repo (как в main_search); реализован парсинг path_prefix в repo и file фильтры для Sourcegraph API.
- Промпт chat_system_gather.txt: упрощён, удалены подробные примеры команд, заменены компактным списком утилит; инструменты проиндексированы по важности использования; добавлено описание graphrag_query; улучшен порядок использования инструментов.
- Настройка Docker Sourcegraph: исправлен URL загрузки src-cli (https://sourcegraph.com/.api/src-cli/src_linux_amd64); добавлен platform: linux/amd64 для M4; исправлен путь к бинарнику (/server server вместо /usr/local/bin/sourcegraph); исправлен порт в compose (3080:7080 вместо 3080:3080); entrypoint использует 127.0.0.1:7080 внутри контейнера.
- Провижинг Sourcegraph: добавлена проверка GraphQL API перед логином; компактная логика ожидания готовности с повторными попытками; автоматическое добавление repos через src repos add с file:// URL.
- Архитектура репозиториев: repos копируются в образы при сборке (sourcegraph и sandbox), а не монтируются как volume; это изолирует Sourcegraph от создания служебных файлов (.p4home, .tmp) в исходной папке repos; оба сервиса используют build context корня проекта для доступа к repos; изменения repos требуют пересборки образов.
- Важные выводы: подмодули Git не имеют собственных .git директорий (используют родительский .git), поэтому скрипт поиска repos должен быть гибким; для sandbox с возможностью записи лучше копировать repos в образ, чтобы изменения не затрагивали исходные файлы; Sourcegraph требует write-доступ в /var/opt/sourcegraph/repos для создания .p4home, поэтому монтирование read-only не работает.
