- SG: автопровижининг (admin, repos, autoindex), src-cli в образе, repos init вручную.
- .env: добавлены SOURCEGRAPH_ADMIN_*, PROVISION_REPOS=1; .gitignore позволяет .env.
- Репозитории: работаем из repos/, отказ от knowledge/; REPOS_ROOT вместо KNOWLEDGE_ROOT.
- Sandbox: монтируем repos → /app, добавлен git, обновлены сообщения entrypoint.
- Sourcegraph tools: sg_search/sg_codeintel/sg_blob упрощены; добавлены sg_get_file_content, sg_list_repos, sg_list_repo_files, sg_file_chunks (символы→чанки, fallback по строкам).
- Индексация ES (build.py): полностью через SG+SCIP чанки; хэш по контенту SG; дифф манифеста против actual из SG; удаление из ES по удалённым; маскировка секретов и лог находок; ignore на уровне файла.
- Упрощение build.py: удалены ридеры/try-except/старые сплиттеры; чистый пайплайн SG→ES.
- GraphRAG: вынесен в graphrag_build.py; build.py больше не вызывает пересборку.
- tools.py: упрощён, graphrag_query без обёрток, REPOS_ROOT напрямую.
- Промпты: chat_system_gather.txt — добавлен git в список утилит.
- Прочее: удалён PROP_GRAPH_INDEX; удалены сканы по всему дереву из check.py; mask.py теперь предоставляет mask_secrets для текста.
- Рефакторинг utils.py: перенесён весь код из ignore.py (is_ignored, IGNORE_SPEC) и check.py (check_secrets_in_text, classify_secret_type, EMOJI_MAP) в utils.py для централизации утилит; удалены файлы ignore.py и check.py.
- Упрощение utils.py: удалены проверки существования REPOS_ROOT и IGNORE_FILE (правило "не страхуйся"), создан глобальный logger для utils вместо создания внутри функций; все импорты вынесены в глобальные (убраны локальные import hashlib и from mask import).
- Исправление по .cursorrules: удалены страховки от граничных случаев (if not text в clean_text), удалены комментарии (# Sourcegraph), все импорты только глобальные.

- Ветки (rev) в индексации: добавлено поле rev в manifest ES и metadata каждого чанка; функция sg_get_repo_rev получает текущую ветку из Sourcegraph; логика синхронизации сравнивает hash и rev - при изменении rev добавляются новые чанки, старые не удаляются; хранятся все ветки всех репозиториев.
- Фильтрация по веткам: retriever.py фильтрует чанки по metadata.rev при поиске; если rev не указан, определяется из path_prefix или первого репозитория; main_search требует обязательный параметр rev в схеме tools.
- Список веток в промптах: добавлены функции get_all_repos_branches и get_all_repos_branches_formatted в sourcegraph.py; список веток всех репозиториев автоматически вставляется в navigation промпт через placeholder {BRANCHES_INFO}; компактный формат (первые 10 веток, остальные +N).
- Бинарные файлы: sg_get_file_content возвращает None для бинарных файлов; добавлена extract_binary_content с поддержкой PDF/DOCX/PPTX/CSV/XLS/изображений через OCR (pytesseract); бинарные файлы создают один чанк с обрезкой до 4096 символов, kind="binary".
- Упрощения: убрана лишняя проверка content в calc_hash; функция sg_list_repo_branches удалена, логика встроена в get_all_repos_branches.
- Переименование rev→branch: все упоминания rev переименованы в branch во всех файлах (build.py, retriever.py, tools.py, chat.py, sourcegraph.py, manifest.json); branch теперь явно означает ветку Git, а не коммит SHA; функция sg_get_repo_rev переименована в sg_get_repo_branch и читает текущую ветку из локального .git/HEAD.
- Обязательный параметр branch: все инструменты (main_search, sg_search, sg_codeintel, sg_blob) требуют обязательный параметр branch; удалены дефолтные значения для branch, path_prefix, top_n; TOOLS_SCHEMA помечает все параметры как required с описаниями ожидаемых значений.
- Централизация обработки файлов: вся логика извлечения контента, чанкинга и санитизации перенесена в sourcegraph.py; создана функция get_file_chunks которая обрабатывает бинарные и текстовые файлы единообразно; функция get_file_hash получает hash напрямую из Sourcegraph oid без fallback на контент.
- Обработка бинарных файлов: бинарные файлы теперь дробятся на чанки через custom_split вместо одного чанка на 4096 символов; _extract_binary_content загружает файлы из Sourcegraph напрямую в память (BytesIO) без сохранения на диск; удалены все страховки и try-except блоки из _extract_binary_content согласно .cursorrules.
- Упрощение метаданных чанков: удалены поля symbol и kind из метаданных чанков в ES (оставлены только doc_id, start_line, end_line, chunk_id, chunk_total, branch); убрана функция _create_chunk, её логика встроена в _split_by_symbols и custom_split.
- Упрощение build.py: удалена неиспользуемая функция delete_file; логика process_files упрощена с прямыми вызовами delete_chunks и delete_manifest; добавлены try-except блоки для обработки ошибок отдельных файлов без остановки всего процесса; функция process_file выделена для обработки одного файла.
- Упрощение sourcegraph.py: убраны все избыточные проверки и страховки (.get() заменены на прямое обращение, убраны min/max для line numbers, удалены проверки if not content); удалены параметры doc_id и line из sg_codeintel; doc_id переименован в rel_path в sg_blob; все функции используют rel_path вместо раздельных repo/path где возможно.

- Переход на минималистичную индексацию одной ветки: удалён аргумент branch из всех инструментов (main_search, sg_search, sg_codeintel, sg_blob, code_stats); Sourcegraph API всегда использует HEAD; манифест ES хранит только rel_path и hash (без branch); удалены все упоминания архитектурной статистики; скрипт sg_get_repo_branch перенесён в utils.py, затем удалён (заменён на "HEAD").
- Оптимизация sg_list_repo_files: заменён N+1 GraphQL-запросов на единую команду git ls-tree -r HEAD для получения всех файлов с OID за один вызов; используется git_blob_oid из utils.py вместо SHA256 для соответствия Sourcegraph.
- Стандартизация фильтрации: sg_search и sg_codeintel используют path_prefix вместо repo (как в main_search); реализован парсинг path_prefix в repo и file фильтры для Sourcegraph API.
- Промпт chat_system_gather.txt: упрощён, удалены подробные примеры команд, заменены компактным списком утилит; инструменты проиндексированы по важности использования; добавлено описание graphrag_query; улучшен порядок использования инструментов.
- Настройка Docker Sourcegraph: исправлен URL загрузки src-cli (https://sourcegraph.com/.api/src-cli/src_linux_amd64); добавлен platform: linux/amd64 для M4; исправлен путь к бинарнику (/server server вместо /usr/local/bin/sourcegraph); исправлен порт в compose (3080:7080 вместо 3080:3080); entrypoint использует 127.0.0.1:7080 внутри контейнера.
- Провижинг Sourcegraph: добавлена проверка GraphQL API перед логином; компактная логика ожидания готовности с повторными попытками; автоматическое добавление repos через src repos add с file:// URL.
- Архитектура репозиториев: repos копируются в образы при сборке (sourcegraph и sandbox), а не монтируются как volume; это изолирует Sourcegraph от создания служебных файлов (.p4home, .tmp) в исходной папке repos; оба сервиса используют build context корня проекта для доступа к repos; изменения repos требуют пересборки образов.
- Важные выводы: подмодули Git не имеют собственных .git директорий (используют родительский .git), поэтому скрипт поиска repos должен быть гибким; для sandbox с возможностью записи лучше копировать repos в образ, чтобы изменения не затрагивали исходные файлы; Sourcegraph требует write-доступ в /var/opt/sourcegraph/repos для создания .p4home, поэтому монтирование read-only не работает.

- Маскирование секретов: создан mask.py с функцией main() которая копирует repos → repos_safe с маскированием текстовых файлов через mask_secrets; бинарные файлы обрабатываются через extract_binary_content; repos_safe добавляется в .gitignore; после маскирования инициализируется git-репозиторий в repos_safe с первым коммитом.
- Docker образы: sandbox и sourcegraph копируют repos_safe в образы (изоляция), graphrag также копирует repos_safe → /app/repos; Sourcegraph монтирует только подпапки (postgresql, zoekt, blobstore, redis, grafana, prometheus) для персистентности, не монтирует /var/opt/sourcegraph/repos чтобы не перекрывать repos из образа; GraphRAG монтирует только ./data/graphrag/.graphrag для сохранения индекса между пересозданиями контейнера.
- GraphRAG автоматизация: индексация запускается автоматически в entrypoint.sh при первом запуске контейнера; если индекс уже существует (проверка .graphrag/config.yaml) - индексация пропускается; индекс сохраняется в volume между пересозданиями контейнера; graphrag_query в tools.py теперь работает через Docker API (обращение к контейнеру rag-assistant-graphrag-1) вместо локального запуска; удалён graphrag_build.py - вся логика в entrypoint.sh.
- Изоляция и персистентность: repos полностью изолированы в образах (не монтируются), данные требуют персистентности (индексы, БД) монтируются отдельными подпапками; при пересборке образа repos обновляются из repos_safe; при перезапуске контейнера repos остаются из образа.

- Переход на монорепозиторий: удалена функция list_all_files из utils.py, логика встроена в build.py через REPOS_ROOT.rglob('**/*'); build.py больше не итерируется по репозиториям, обрабатывает все файлы напрямую; удалена функция _split_file_path из sourcegraph.py - работа напрямую с rel_path как путём внутри монорепозитория; добавлена константа SOURCEGRAPH_REPO_NAME в utils.py для имени единого репозитория.
- Упрощение sourcegraph.py: убраны все фильтры по репозиторию из sg_search и sg_codeintel (репозиторий всегда один); убрана переменная $repo из GraphQL запросов - имя репозитория встроено как константа через f-string; убрана переменная $rev из GraphQL запросов - rev: HEAD встроен как константа в запрос; все функции работают с rel_path как путём внутри монорепозитория без разделения на repo/path.
- Упрощение build.py: цикл по файлам через REPOS_ROOT.rglob('**/*') с фильтрацией is_file и is_ignored в условии генератора; удалены неиспользуемые импорты os из tools.py; проверка is_ignored выполняется до вычисления hash; игнорируемые файлы получают current_hash=None и удаляются из индекса.
- Обновление документации: README обновлён для описания работы с монорепозиторием; добавлено описание процесса repos/ (исходные) → mask.py → repos_safe/ → docker compose build → build.py → chat.py; обновлены примеры использования инструментов без параметра repo; промпты обновлены для монорепозитория.

=== Настройка авторизации Sourcegraph 6.x ===

Проблема: Sourcegraph 6.x не поддерживает Basic Auth для GraphQL API, требуется токен.

Решение: 
- Убрана автоматическая генерация токена через entrypoint (CSRF проблемы)
- Токен создаётся вручную через UI Sourcegraph
- Python код читает токен из SOURCEGRAPH_TOKEN env переменной
- Добавлена инструкция в README.md (раздел 2.1)

Файлы изменены:
- sourcegraph.py: упрощена логика, только чтение из SOURCEGRAPH_TOKEN
- images/sourcegraph/entrypoint.sh: убрана функция create_token, оставлен только src serve-git
- images/sourcegraph/extsvc.json: исправлен путь repos/.git (реальный путь от src serve-git)
- README.MD: добавлена инструкция по созданию токена

Важно: 
- repos/.git - это реальный путь который отдаёт src serve-git
- repositoryPathPattern: "monorepo" - только для отображения в UI, не меняет URL клонирования

=== Удаление GraphRAG из проекта ===

Причина: GraphRAG не поддерживает локальные embedding модели (BAAI/bge-m3) - требует API ключи даже для HuggingFace моделей, сложная настройка через litellm, отсутствует инкрементальность индексации, проблемы с совместимостью моделей.

Что удалено:
- Сервис graphrag из docker-compose.yml
- Директория images/graphrag/ (Dockerfile, entrypoint.sh, settings.yaml)
- Функция graphrag_query из tools.py
- Инструмент graphrag_query из TOOLS_SCHEMA
- Переменная GRAPHRAG_CONTAINER_NAME из utils.py
- Импорты и использование graphrag_query из chat.py
- Упоминание graphrag_query из промпта chat_system_gather.txt
- Все упоминания GraphRAG из README.MD (архитектура, инструменты, описание)

Осталось: Elasticsearch (гибридный поиск), Sourcegraph (структурный анализ), Docker Sandbox (безопасное выполнение команд).

- Добавлен инструмент sg_file_neighbors: находит структурных соседей файла через references символов (sourcegraph.py); добавлен в TOOLS_SCHEMA (tools.py) и TOOLS_MAP (chat.py); описан в промпте chat_system_gather.txt; обновлен README.MD с примером использования.


- [ПРОБЛЕМА ИНДЕКСАЦИИ SOURCEGRAPH] Найдено: Sourcegraph возвращает одинаковые символы для всех файлов (включая YAML). Это указывает на отсутствие корректной SCIP-индексации - используется один общий индекс вместо отдельных для каждого файла. Не влияет на работу sg_file_neighbors (функция корректно обрабатывает данные API), но результаты могут быть неточными для файлов без реальных символов.

=== ОТКАЗ ОТ SOURCEGRAPH ===

Причина отказа: Sourcegraph слишком тяжеловесный, мало манёвренный и мало полезный для нашего кейса.

Проблемы:
- SCIP индексация требует конфигурации проектов для КАЖДОГО языка (pom.xml, build.gradle, package.json, go.mod и т.д.)
- В монорепо с перемешанными файлами без структуры проектов Sourcegraph падает в fallback (ctags), возвращая одинаковые символы для всех файлов
- Precise-индексаторы не могут автоматически определить структуру в перемешанных файлах
- Требует настройки токенов, сложная конфигурация, большой overhead

Решение: полное удаление Sourcegraph из проекта.

Что удалено:
- Сервис sourcegraph из docker-compose.yml
- Сервис caddy из docker-compose.yml (использовался только для Sourcegraph)
- Директория images/sourcegraph/ (Dockerfile, entrypoint.sh, index.sh, extsvc.json)
- Файл sourcegraph.py со всеми функциями (sg_search, sg_codeintel, sg_blob, sg_file_neighbors)
- Инструменты sg_* из tools.py и TOOLS_SCHEMA
- TOOLS_MAP маппинги для sg_* из chat.py
- Упоминания Sourcegraph из промптов (chat_system_gather.txt)
- Все упоминания Sourcegraph из README.MD
- Переменные SOURCEGRAPH_* из utils.py
- Переменные SOURCEGRAPH_* из .env примеров
 
=== Переход на один индекс (chunks) и унификация метаданных ===
- Удалён индекс files; весь файл хранится как функциональный чанк: chunk_id=0, kind=whole
- build.py: сплит → prepend whole-блок → описываем каждый блок одним тулом → индексируем actions напрямую (bulk)
- Универсальный тул describe_tool: один schema для файла и чанков; старые DESCRIBE_FILE/Block удалены
- Промпты: оставлены split_blocks.txt и describe.txt; describe_block.txt/describe_file.txt удалены
- Поля синхронизированы: и в chunk(включая id=0) и в файле (теперь тоже в чанке) есть hash, text, embedding, llm_version, size, lines, extension, filename, mime, created_at, updated_at
- edges упрощён: список строк формата typeA@nameA→typeB@nameB (для графа зависимостей)
- tools.py: добавлены/уточнены поля likely_queries, io, symbols, security_flags; descriptions выровнены
- retriever.py: исключает функциональные чанки фильтром chunk_id>=1
- images/elasticsearch: удалён index_files.json; entrypoint.sh/Dockerfile создают/копируют только index_chunks.json
- utils.py: удалён ES_INDEX_FILES; добавлен EMBED_DIMS (по умолчанию 1024)
- docker-compose.yml: переменная ES_INDEX_FILES удалена