[LLM: читай полностью перед правкой, обновляй при изменении логики]

@docstring/_README.txt

НАЗВАНИЕ:
Hybrid Retriever — гибридный поиск с reranking и статистикой

SUMMARY:
Нативный гибридный поиск в Elasticsearch (kNN + BM25) с SBERT-reranking.
Один запрос к ES объединяет векторный и полнотекстовый поиск; поддержка фильтрации по префиксу пути.
ES клиент создаётся локально. Дополнительно: статистика кодовой базы через ES агрегации.

ВЫВОДЫ:
- Локальные объекты: ES клиент, Settings.embed_model, RERANKER создаются здесь.
- Settings.embed_model загружается здесь для векторизации запросов (используется в HybridESRetriever._retrieve).
- HybridESRetriever: единый ES-запрос с knn + query.bool.should (ES объединяет скоры нативно).
- num_candidates = top_k * 5 для HNSW recall при фильтрации.
- Фильтрация: prefix query по doc_id применяется к knn и query на уровне ES.
- Reranking: SBERT top_n=10 финализирует ранжирование.
- retrieve_fusion_nodes: entry point для гибридного поиска (top_k=30 → rerank to 10).
- metadata из ES хранится в отдельном объекте "metadata" (chunk_id, chunk_total, start_line, end_line, file_path); doc_id на верхнем уровне.
- normal_prefix: убирает лидирующие слэши/точки.
- get_code_stats: ES агрегации для базовой статистики (файлы, чанки, языки, размеры, топ файлы).
- get_architecture_stats: ES агрегации для архитектурной статистики (слои, зависимости, сложность, дублирование).
- Fail-fast без подстраховок: отсутствие обязательных полей вызывает KeyError.

АНТИПАТТЕРНЫ:
- Вызывать два отдельных запроса (kNN, BM25) и объединять в Python — ES делает это эффективнее.
- Использовать num_candidates = top_k без запаса — теряется recall при фильтрации.
- Забывать применить фильтр и к knn, и к query — часть результатов будет вне scope.
- Передавать embedding в metadata ноды — раздувает память без пользы.
- Обрабатывать None значения в агрегациях — проверяем через or 0.

ЗАМЕТКИ:
- DEVICE: cuda > mps > cpu (автоопределение для reranker).
- ES multi_match: буст для ru^1.3, en^1.2 над базовым text^1.0.
- nodes_to_text: форматирует ноды как "doc_id [chunk N/M] Lines X-Y:\ntext".
- Статистика: компактный вывод через циклы, обработка None значений, эмодзи для читаемости.
- Агрегации: files, chunks, avg_chunk_size, languages, top_files, largest_files, recent_files, file_extensions.

