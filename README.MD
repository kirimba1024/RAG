# RAG Assistant

**Claude-powered ะบะพะด-ะฐััะธััะตะฝั ั ะณะธะฑัะธะดะฝัะผ ะฟะพะธัะบะพะผ (Elasticsearch) ะธ ะฑะตะทะพะฟะฐัะฝัะผ ะฒัะฟะพะปะฝะตะฝะธะตะผ ะบะพะผะฐะฝะด (Docker Sandbox)**

## ๐ฏ ะััะธัะตะบัััะฐ

### ะะฐะทะดะตะปะตะฝะธะต ะพัะฒะตัััะฒะตะฝะฝะพััะธ
- **Elasticsearch**: ะฒะตะบัะพัะฝัะน ะฟะพะธัะบ (kNN) + ะฟะพะปะฝะพัะตะบััะพะฒัะน (BM25) ะฟะพ chunks ะบะพะดะฐ
- **Docker Sandbox**: ะฑะตะทะพะฟะฐัะฝะพะต ะฒัะฟะพะปะฝะตะฝะธะต ะบะพะผะฐะฝะด ะดะปั ะฐะฝะฐะปะธะทะฐ ัะฐะนะปะพะฒ ะธ ะบะพะดะฐ
- **Claude**: ัะธะบะป ั tool calling (ะฒัะทะพะฒ ะธะฝััััะผะตะฝัะพะฒ ะฟะพ ะผะตัะต ะฝะตะพะฑัะพะดะธะผะพััะธ ะดะพ ัะพัะผะธัะพะฒะฐะฝะธั ะพัะฒะตัะฐ)

### ะะปััะตะฒัะต ะบะพะผะฟะพะฝะตะฝัั
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ main_search (ES)                    โ
โ โข kNN ะฒะตะบัะพัะฝัะน ะฟะพะธัะบ               โ
โ โข BM25 ะฟะพะปะฝะพัะตะบััะพะฒัะน               โ
โ โข Chunks ั ะผะตัะฐะดะฐะฝะฝัะผะธ (ัััะพะบะธ)     โ
โ โ ะะตะปะตะฒะฐะฝัะฝัะต chunks ัะตะบััะฐ         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              +
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ execute_command (Docker)            โ
โ โข ะะตะทะพะฟะฐัะฝะพะต ะฒัะฟะพะปะฝะตะฝะธะต ะบะพะผะฐะฝะด      โ
โ โข Unix ััะธะปะธัั: grep, find, awk     โ
โ โข Read-only ัะฐะนะปะพะฒะฐั ัะธััะตะผะฐ        โ
โ โ ะะฝะฐะปะธะท ัะฐะนะปะพะฒ ะธ ะบะพะดะฐ              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Claude Agent (ัะธะบะป ั tool calling)  โ
โ โข ะัะทะพะฒ ะธะฝััััะผะตะฝัะพะฒ ะฟะพ ะผะตัะต        โ
โ   ะฝะตะพะฑัะพะดะธะผะพััะธ                     โ
โ โข ะคะพัะผะธัะพะฒะฐะฝะธะต ะพัะฒะตัะฐ ะฝะฐ ะพัะฝะพะฒะต     โ
โ   ัะพะฑัะฐะฝะฝะพะณะพ ะบะพะฝัะตะบััะฐ              โ
โ โ ะะพะปะฝัะน ะบะพะฝัะตะบัั = ัะตะบัั + ะบะพะผะฐะฝะดั โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะปััะตะฒัะต ัะฐะนะปั
- `build.py` โ ะธะฝะบัะตะผะตะฝัะฐะปัะฝะฐั ะธะฝะดะตะบัะฐัะธั repos_safe/ ะฒ ES
- `chat.py` โ Gradio ะธะฝัะตััะตะนั ั ัะธะบะปะพะผ tool calling ะธ ััะผะผะฐัะธะทะฐัะธะตะน ะดะธะฐะปะพะณะฐ
- `retriever.py` โ ะณะธะฑัะธะดะฝัะน ะฟะพะธัะบ ES (kNN+BM25+reranking)
- `tools.py` โ ะธะฝััััะผะตะฝัั ะดะปั Claude (main_search, execute_command)
- `utils.py` โ ะบะพะฝัะธะณััะฐัะธั ะธ ะฒัะฟะพะผะพะณะฐัะตะปัะฝัะต ััะฝะบัะธะธ
- `mask.py` โ ะผะฐัะบะธัะพะฒะบะฐ ัะตะบัะตัะพะฒ ะฟัะธ ะธะฝะดะตะบัะฐัะธะธ
- `docker-compose.yml` โ ะพัะบะตัััะฐัะธั ัะตัะฒะธัะพะฒ (ES, Kibana, Sandbox)

## ๐ ะัััััะน ััะฐัั

### 1. ะะฐัััะพะนะบะฐ ะพะบััะถะตะฝะธั
```bash
# ะกะพะทะดะฐะนัะต .env ัะฐะนะป
ANTHROPIC_API_KEY=sk-ant-api03-...

# ะะพะดะตะปั Claude ะดะปั ะพัะฒะตัะพะฒ
CLAUDE_MODEL=claude-3-5-sonnet-latest

# ========================================
# Elasticsearch (ะฒะตะบัะพัะฝัะน ะฟะพะธัะบ)
# ========================================

# ะฅะพัั ะธ ะฟะพัั Elasticsearch
ES_HOST=localhost
ES_PORT=9200

# ะะฝะดะตะบั ะดะปั ัะฐะฝะบะพะฒ
ES_INDEX_CHUNKS=chunks

# ะะฝะดะตะบั ะดะปั ะผะฐะฝะธัะตััะพะฒ ัะฐะนะปะพะฒ (ะพะฟัะธะพะฝะฐะปัะฝะพ, ะฟะพ ัะผะพะปัะฐะฝะธั file_manifest)
ES_INDEX_FILE_MANIFEST=file_manifest

# ========================================
# Embeddings ะธ Reranking
# ========================================

# ะะพะดะตะปั ะดะปั ะฒะตะบัะพัะฝัั ัะผะฑะตะดะดะธะฝะณะพะฒ
EMBED_MODEL=BAAI/bge-m3

# ะะพะดะตะปั ะดะปั reranking ัะตะทัะปััะฐัะพะฒ
RERANK_MODEL=BAAI/bge-reranker-large

# ========================================
# ะะฐะทั ะดะฐะฝะฝัั (PostgreSQL, ะพะฟัะธะพะฝะฐะปัะฝะพ)
# ========================================
# ะคะพัะผะฐั: DB_<X>_URL, DB_<X>_USERNAME, DB_<X>_PASSWORD, DB_<X>_DESCRIPTION, DB_<X>_TOOL_NAME
# ะณะดะต <X> - ะฝะพะผะตั ะฑะฐะทั ะดะฐะฝะฝัั (1, 2, 3, ...)
# tool_name - ัะฝะธะบะฐะปัะฝะพะต ะธะผั ััะปะฐ ะฒ ััะธะปะต ั ะฟะพะดัะตัะบะธะฒะฐะฝะธัะผะธ (ะฝะฐะฟัะธะผะตั: query_main_db)

# ะัะธะผะตั ะดะปั ะฟะตัะฒะพะน ะะ:
# DB_1_URL=postgresql://localhost:5432/mydb
# DB_1_USERNAME=user
# DB_1_PASSWORD=password
# DB_1_DESCRIPTION=Main production database
# DB_1_TOOL_NAME=query_main_db

```

### 2. ะะฐะฟััะบ ะฒัะตั ัะตัะฒะธัะพะฒ
```bash
docker compose up -d
```

**ะกะตัะฒะธัั:** 
- Elasticsearch :9200 (ะฟะพะธัะบ)
- Kibana :5601 (ะฒะธะทัะฐะปะธะทะฐัะธั ES)
- Sandbox (ะธะทะพะปะธัะพะฒะฐะฝะฝะฐั ััะตะดะฐ ะดะปั ะบะพะผะฐะฝะด)

ะะฐัะฐะปะพะณะธ:
- `repos/` โ ะธััะพะดะฝัะต Git-ัะตะฟะพะทะธัะพัะธะธ (ััััะต, ั ัะตะบัะตัะฐะผะธ)
- `repos_safe/` โ ะผะฐัะบะธัะพะฒะฐะฝะฝัะต ัะตะฟะพะทะธัะพัะธะธ (ัะพะทะดะฐัััั ัะตัะตะท `mask.py`, ะธัะฟะพะปัะทััััั ะดะปั ะธะฝะดะตะบัะฐัะธะธ ะธ Docker-ะพะฑัะฐะทะพะฒ)

### 3. ะะพะดะณะพัะพะฒะบะฐ ัะตะฟะพะทะธัะพัะธะตะฒ
```bash
# 1. ะะพะผะตััะธัะต ะธััะพะดะฝัะต ัะตะฟะพะทะธัะพัะธะธ ะฒ repos/
# 2. ะะฐะฟัััะธัะต ะผะฐัะบะธัะพะฒะฐะฝะธะต ัะตะบัะตัะพะฒ
python mask.py  # ัะพะทะดะฐัั repos_safe/ ะธะท repos/
# 3. ะะตัะตัะพะฑะตัะธัะต Docker-ะพะฑัะฐะทั ะดะปั ะธัะฟะพะปัะทะพะฒะฐะฝะธั repos_safe/
docker compose build
# 4. ะะฐะฟัััะธัะต ัะตัะฒะธัั (Elasticsearch, etc.)
docker compose up -d
# 5. ะะฝะดะตะบัะธััะนัะต repos_safe/ ะฒ Elasticsearch
python build.py
# 6. ะะฐะฟัััะธัะต ะธะฝัะตััะตะนั
python chat.py  # โ http://localhost:7860
```

**ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพััั:**
1. `repos/` (ะธััะพะดะฝัะต) โ 
2. `mask.py` โ `repos_safe/` โ 
3. `docker compose build` (ะพะฑัะฐะทั ั ะทะฐะผะฐัะบะธัะพะฒะฐะฝะฝัะผะธ ัะตะฟะพะทะธัะพัะธัะผะธ) โ 
4. `python build.py` (ะธะฝะดะตะบัะฐัะธั) โ 
5. `python chat.py` (ะธะฝัะตััะตะนั)

### 4. Python ะทะฐะฒะธัะธะผะพััะธ
```bash
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt -c constraints.txt
```

## ๐ง ะะฝััััะผะตะฝัั Claude

1. **main_search** โ ะณะธะฑัะธะดะฝัะน ะฟะพะธัะบ (kNN+BM25) ะฟะพ chunks ะบะพะดะฐ
  ```python
  question="ะะดะต ะผะตัะพะด ะฐััะตะฝัะธัะธะบะฐัะธะธ?", path_prefix="src", top_n=10, symbols=["UserService"], use_reranker=True
  ```
  - `question`: ะฟะพะธัะบะพะฒัะน ะทะฐะฟัะพั ะฝะฐ ััััะบะพะผ ัะทัะบะต (ะบะพะด ะธ ะดะพะบัะผะตะฝัะฐัะธั ะฟัะพะธะฝะดะตะบัะธัะพะฒะฐะฝั ะฝะฐ ััััะบะพะผ)
  - `symbols` (ะพะฟัะธะพะฝะฐะปัะฝะพ): ัะฟะธัะพะบ ะธะดะตะฝัะธัะธะบะฐัะพัะพะฒ ะดะปั ััะพัะฝะตะฝะธั ะฟะพะธัะบะฐ
  - `use_reranker` (ะพะฟัะธะพะฝะฐะปัะฝะพ): ะฑัะปะตะฒะพ ะทะฝะฐัะตะฝะธะต, ะฒะบะปััะฐะตั reranker (true ะฟะพ ัะผะพะปัะฐะฝะธั); reranker ัะฐะฑะพัะฐะตั ัะพะปัะบะพ ั ัะตะผะฐะฝัะธัะตัะบะธะผ ััะพะดััะฒะพะผ ัะตะบััะฐ ะธ ะฝะต ััะธััะฒะฐะตั ะผะตัะฐะดะฐะฝะฝัะต (symbols)

2. **execute_command** โ ะฑะตะทะพะฟะฐัะฝะพะต ะฒัะฟะพะปะฝะตะฝะธะต ะบะพะผะฐะฝะด ะฒ Docker sandbox
   ```bash
   grep -rn "class.*Service" . --include="*.java"
   find . -name "*.py" -exec wc -l {} + | sort -nr
   cat src/main/java/com/example/Service.java
   ```

3. **db_query** (ะดะธะฝะฐะผะธัะตัะบะธะต ััะปั) โ ะฒัะฟะพะปะฝะตะฝะธะต SQL ะทะฐะฟัะพัะพะฒ ะบ ะฑะฐะทะฐะผ ะดะฐะฝะฝัั ัะตัะตะท NL2SQL
   - ะะปั ะบะฐะถะดะพะน ะะ ัะพะทะดะฐัััั ะพัะดะตะปัะฝัะน tool ั ัะฝะธะบะฐะปัะฝัะผ ะธะผะตะฝะตะผ ะธะท `DB_<X>_TOOL_NAME`
   - LLM ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะพะปััะฐะตั ััะตะผั ะะ ะธ ะณะตะฝะตัะธััะตั SQL ะฝะฐ ะพัะฝะพะฒะต ะฒะพะฟัะพัะฐ ะฝะฐ ะตััะตััะฒะตะฝะฝะพะผ ัะทัะบะต
   - Read-only ะดะพัััะฟ: ัะพะปัะบะพ SELECT ะทะฐะฟัะพัั, statement_timeout=30s
   - ะะพะฝัะธะณััะฐัะธั ัะตัะตะท ENV: `DB_<X>_URL`, `DB_<X>_USERNAME`, `DB_<X>_PASSWORD`, `DB_<X>_DESCRIPTION`, `DB_<X>_TOOL_NAME`

## ๐ ะะพะดะดะตัะถะธะฒะฐะตะผัะต ัะพัะผะฐัั

LLM ะพะฑัะฐะฑะฐััะฒะฐะตั ะปัะฑะพะน ัะตะบััะพะฒัะน ัะฐะนะป ะพะดะธะฝะฐะบะพะฒะพ โ ะฝะตั ะพะณัะฐะฝะธัะตะฝะธะน ะฝะฐ ัะพัะผะฐัั. ะะพะปะต `lang` ะฒ ะผะตัะฐะดะฐะฝะฝัั ัะฐะฝะบะพะฒ ะพะฟัะตะดะตะปัะตััั ะฟะพ ัะฐััะธัะตะฝะธั ัะฐะนะปะฐ ะดะปั ัะดะพะฑััะฒะฐ, ะฝะพ ะฝะต ะฒะปะธัะตั ะฝะฐ ะพะฑัะฐะฑะพัะบั.

## ๐ก๏ธ ะะตะทะพะฟะฐัะฝะพััั

**Docker Sandbox:**
- ะะทะพะปะธัะพะฒะฐะฝะฝะฐั ััะตะดะฐ ะดะปั ะฒัะฟะพะปะฝะตะฝะธั ะบะพะผะฐะฝะด
- Read-only ัะฐะนะปะพะฒะฐั ัะธััะตะผะฐ (ะฝะตะปัะทั ะธะทะผะตะฝะธัั ะบะพะด)
- ะะณัะฐะฝะธัะตะฝะฝัะต ัะตััััั (200MB RAM, 50% CPU)
- ะขะฐะนะผะฐัั 30 ัะตะบัะฝะด ะฝะฐ ะบะพะผะฐะฝะดั
- ะะพะปัะทะพะฒะฐัะตะปั `nobody` ะดะปั ะดะพะฟะพะปะฝะธัะตะปัะฝะพะน ะฑะตะทะพะฟะฐัะฝะพััะธ

**ะะพัััะฟะฝัะต ััะธะปะธัั ะฒ sandbox:**
`grep`, `find`, `awk`, `sed`, `bash`, `jq`, `tree`, `file`, `diff`, `less`, `vim`

**ะะตะทะพะฟะฐัะฝะพััั:**
- ะกะตัั ะพัะบะปััะตะฝะฐ (`network_mode: none`) โ ะฝะตั ะดะพัััะฟะฐ ะบ ะฒะฝะตัะฝะธะผ ัะตััััะฐะผ
- curl/wget ัะดะฐะปะตะฝั โ ะฝะตั ะฒะพะทะผะพะถะฝะพััะธ ะดะปั ัะตัะตะฒะพะน ัะฐะทะฒะตะดะบะธ

## ๐๏ธ ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั

### ะะพะดะณะพัะพะฒะบะฐ ะดะฐะฝะฝัั
1. **ะััะพะดะฝัะต ัะตะฟะพะทะธัะพัะธะธ (`repos/`):**
   - ะกัััะต Git-ัะตะฟะพะทะธัะพัะธะธ ั ัะตะบัะตัะฐะผะธ
   - ะัะฟะพะปัะทััััั ัะพะปัะบะพ ะบะฐะบ ะธััะพัะฝะธะบ ะดะปั ะผะฐัะบะธัะพะฒะฐะฝะธั
   
2. **ะะฐัะบะธัะพะฒะฐะฝะธะต (`mask.py`):**
   - ะะพะฟะธััะตั `repos/` โ `repos_safe/`
   - ะะฐัะบะธััะตั ัะตะบัะตัั ะฒ ัะตะบััะพะฒัั ัะฐะนะปะฐั (ัะพะบะตะฝั, ะฟะฐัะพะปะธ, ะบะปััะธ)
   - ะะฑัะฐะฑะฐััะฒะฐะตั ะฑะธะฝะฐัะฝัะต ัะฐะนะปั ัะตัะตะท OCR
   - ะะฝะธัะธะฐะปะธะทะธััะตั git-ัะตะฟะพะทะธัะพัะธะน ะฒ `repos_safe/`
   
3. **Docker-ะพะฑัะฐะทั:**
   - `repos_safe/` ะบะพะฟะธััะตััั ะฒ ะพะฑัะฐะทั ะฟัะธ `docker compose build`
   - Sandbox ะธัะฟะพะปัะทัะตั ะทะฐะผะฐัะบะธัะพะฒะฐะฝะฝัะต ัะตะฟะพะทะธัะพัะธะธ

### ะะฝะดะตะบัะฐัะธั (build.py)
1. **ะะพะปััะตะฝะธะต ัะฐะนะปะพะฒ:**
   - ะกะบะฐะฝะธัะพะฒะฐะฝะธะต `repos_safe/` ะดะปั ะฟะพะปััะตะฝะธั ะฒัะตั ัะฐะนะปะพะฒ
   
2. **ะกะตะผะฐะฝัะธัะตัะบะพะต ัะฐะทะฑะธะตะฝะธะต ะธ ะธะทะฒะปะตัะตะฝะธะต ะผะตัะฐะดะฐะฝะฝัั:**
   - LLM (Claude) ัะฐะทะฑะธะฒะฐะตั ัะฐะนะป ะฝะฐ ะปะพะณะธัะตัะบะธะต ะฑะปะพะบะธ ะธ ััะฐะทั ะธะทะฒะปะตะบะฐะตั ะดะปั ะบะฐะถะดะพะณะพ ะฑะปะพะบะฐ: symbols
   - Whole-ะฑะปะพะบะธ ะฝะต ัะพะทะดะฐัััั ะธ ะฝะต ัะผะฑะตะดะดัััั (ะธัะบะปััะตะฝั ะธะท ะธะฝะดะตะบัะฐัะธะธ)
   - ะะฐะฝะธัะตัั ัะฐะนะปะฐ ัะพะทะดะฐัััั ะฒ ะพัะดะตะปัะฝะพะผ ะธะฝะดะตะบัะต `file_manifest` ั ะฟะพะปัะผะธ `path` ะธ `hash`
   - ะะตัโะทะฐะฟัะพัะฝะพะต prompt caching (ephemeral) ะดะปั ัะธััะตะผะฝะพะณะพ ะฟัะพะผะฟัะฐ ะธ ัะตะบััะฐ ัะฐะนะปะฐ
   - ะะตะฝะตัะฐัะธั embeddings (BAAI/bge-m3)
   - Bulk insert ะฒ ES (ะธะฝะดะตะบั `chunks`) c ะฟะพะปัะผะธ: `path`, `hash`, `text`, `embedding`, `chunk_id`, `chunks`, `start_line`, `end_line`, `kind`, `lang`, `size` (ัะฐะทะผะตั ัะฐะฝะบะฐ ะฒ ะฑะฐะนัะฐั), `file_size` (ัะฐะทะผะตั ัะฐะนะปะฐ ะฒ ะฑะฐะนัะฐั), `file_lines` (ะพะฑัะตะต ะบะพะปะธัะตััะฒะพ ัััะพะบ ะฒ ัะฐะนะปะต), `symbols`
   
3. **ะะฝะบัะตะผะตะฝัะฐะปัะฝะพััั:**
   - ะฅัั ะบะฐะถะดะพะณะพ ัะฐะนะปะฐ ะฟะพ ัะพะดะตัะถะธะผะพะผั (`git_blob_oid`)
   - ะะพะปะฝะพะต ะฟะตัะตะธะฝะดะตะบัะธัะพะฒะฐะฝะธะต ัะฐะนะปะฐ ัะพะปัะบะพ ะฟัะธ ะธะทะผะตะฝะตะฝะธะธ ัััะฐ; ัะดะฐะปะตะฝะธะต ััะฐััั ัะฐะฝะบะพะฒ ะฟัะธ ะธะทะผะตะฝะตะฝะธะธ/ัะดะฐะปะตะฝะธะธ ัะฐะนะปะฐ

### ะะพะธัะบ (retriever.py)
1. ะะฒะฐ ะพัะดะตะปัะฝัั ะทะฐะฟัะพัะฐ ES ั RRF-ัะปะธัะฝะธะตะผ:
   - BM25 ะทะฐะฟัะพั: ะฟะพะปะฝะพัะตะบััะพะฒัะน ะฟะพะธัะบ ั ะฑัััะฐะผะธ (ru^1.3, en^1.2)
   - kNN ะทะฐะฟัะพั: ะฒะตะบัะพัะฝัะน ะฟะพะธัะบ ะฟะพ embeddings (BAAI/bge-m3)
   - ะะฐะทะผะตั ะบะฐะฝะดะธะดะฐัะพะฒ ะทะฐะฒะธัะธั ะพั top_n: size = shortlist, num_candidates = shortlist * 4, ะณะดะต shortlist = max(6 * top_n, 32) ะฟัะธ use_reranker ะธะปะธ top_n ะฑะตะท reranker
   - ะคะธะปัััะฐัะธั ะฟะพ path_prefix ะบะฐะบ bool.filter (ะฝะต ัะบะพัะตั) ะดะปั ัะผะตะฝััะตะฝะธั ะบะฐะฝะดะธะดะฐัะพะฒ ะธ ััะบะพัะตะฝะธั
   - RRF-ัะปะธัะฝะธะต: ะพะฑัะตะดะธะฝะตะฝะธะต ัะตะทัะปััะฐัะพะฒ BM25 ะธ kNN ัะตัะตะท Reciprocal Rank Fusion (k=60, ะปะธะฝะตะนะฝะฐั ัะปะพะถะฝะพััั)
2. Reranking ัะตัะตะท BAAI/bge-reranker-large (ะพะฟัะธะพะฝะฐะปัะฝะพ, ะบะพะณะดะฐ use_reranker=true, ะฟะพะปััะฐะตั shortlist ะบะฐะฝะดะธะดะฐัะพะฒ, ะฒะพะทะฒัะฐัะฐะตั top_n)
3. ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต ัะตะทัะปััะฐัะพะฒ ั id, chunk_id, ะฝะพะผะตัะฐะผะธ ัััะพะบ, kind, lang, mime, title ะดะปั ััะฐััะธัะพะฒะบะธ


## ๐ ะคะธะปะพัะพัะธั

**ะะฐะถะดะพะต ััะฐะฝะธะปะธัะต ะดะตะปะฐะตั ัะพ, ะดะปั ัะตะณะพ ะพะฟัะธะผะธะทะธัะพะฒะฐะฝะพ:**
- **ES** โ "ะงัะพ ะฝะฐะฟะธัะฐะฝะพ ะฒ ะบะพะดะต?" (chunks ั ะบะพะฝัะตะบััะพะผ)
- **Docker Sandbox** โ "ะะฐะบ ะฒัะฟะพะปะฝะธัั ะฐะฝะฐะปะธะท?" (ะฑะตะทะพะฟะฐัะฝัะต ะบะพะผะฐะฝะดั, read-only)
- **Claude** โ ะฆะธะบะป ั tool calling (ะฒัะทะพะฒ ะธะฝััััะผะตะฝัะพะฒ ะฟะพ ะผะตัะต ะฝะตะพะฑัะพะดะธะผะพััะธ ะดะพ ัะพัะผะธัะพะฒะฐะฝะธั ะพัะฒะตัะฐ)

**ะะตะทัะปััะฐั:** Claude ะฒะธะดะธั ัะตะบััะพะฒัะน ะบะพะฝัะตะบัั ัะตัะตะท ES, ะผะพะถะตั ะฑะตะทะพะฟะฐัะฝะพ ะฐะฝะฐะปะธะทะธัะพะฒะฐัั ะบะพะด ัะตัะตะท ะบะพะผะฐะฝะดั, ะธ ะฒัั ััะพ ะฒ ัะธะบะปะต tool calling ะดะปั ะผะฐะบัะธะผะฐะปัะฝะพะณะพ ะพัะฒะฐัะฐ ะธะฝัะพัะผะฐัะธะธ.

## ๐งน ะฃะฟัะฐะฒะปะตะฝะธะต

**ะะพะปะฝะฐั ะฟะตัะตะธะฝะดะตะบัะฐัะธั:**
```bash
# ะัะธััะบะฐ ES (ะพะฟัะธะพะฝะฐะปัะฝะพ)
curl -X DELETE http://localhost:9200/chunks
curl -X DELETE http://localhost:9200/file_manifest

# ะะตัะตะธะฝะดะตะบัะฐัะธั ES
python build.py
```

**ะัะพัะผะพัั ะดะฐะฝะฝัั:**
```
http://localhost:5601  # Kibana (Elasticsearch ะดะฐะฝะฝัะต)
```

## ๐ ะขะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ

**LLM:**
- BASE_LLM: Claude (ะผะพะดะตะปั ะธะท CLAUDE_MODEL env)
- ะฆะธะบะป ั tool calling: ะผะพะดะตะปั ะฒัะทัะฒะฐะตั ะธะฝััััะผะตะฝัั (main_search, execute_command, db_query) ะฟะพ ะผะตัะต ะฝะตะพะฑัะพะดะธะผะพััะธ ะดะพ ัะพัะผะธัะพะฒะฐะฝะธั ัะธะฝะฐะปัะฝะพะณะพ ะพัะฒะตัะฐ
- Prompt caching ะฒะบะปััะตะฝ (cache_control: ephemeral ะดะปั system-ะฟัะพะผะฟัะพะฒ, ัััะฐะฝะธั ะธััะพัะธะธ ะธ ัะตะทัะปััะฐัะพะฒ ะธะฝััััะผะตะฝัะพะฒ)
- ะััะพัะธั ะบะพะฝัะตะบััะฐ: "ััะธ ะบะพะปััะฐ" ััััะบัััั
  * ะะพะปััะพ 1: ะฝะฐะฒะธะณะฐัะธะพะฝะฝัะน system-ะฟัะพะผะฟั + ะฟะพัะปะตะดะฝะธะต 3 summary-ัััะฐะฝะธัั
  * ะะพะปััะพ 2: ัะฐะฑะพัะธะน ะบะพะฝัะตะบัั ะฒ raw (ะฟะพัะปะตะดะฝะธะต 3 ัะพะพะฑัะตะฝะธั)
  * ะะพะปััะพ 3: ะดะฐะปัะฝะธะน ัะฒะพัั ะฒ history_pages (ะฐะฒัะพััะผะผะฐัะธะทะฐัะธั ะฟัะธ > 3 ัััะฐะฝะธัะฐั)
- ะะฒัะพััะผะผะฐัะธะทะฐัะธั: ะฟัะธ ะฟัะตะฒััะตะฝะธะธ 3 ัััะฐะฝะธั ะฒัะต ัััะฐะฝะธัั ะฐะฒัะพะผะฐัะธัะตัะบะธ ััะปะพะฟัะฒะฐัััั ะฒ ะพะดะฝั summary-ัััะฐะฝะธัั, ัะตะบัั ััะผะผะฐัะธะทะฐัะธะธ ะฟะพะบะฐะทัะฒะฐะตััั ะฒ ัะฐัะต
- ะะพะดััะตั ัะพะบะตะฝะพะฒ: ะธะฝัะตััะตะนั ะพัะพะฑัะฐะถะฐะตั ะพะฑัะตะต ะบะพะปะธัะตััะฒะพ ัะพะบะตะฝะพะฒ ั ััะตัะพะผ ะบััะธัะพะฒะฐะฝะธั (input + cache_write + cache_read ะดะปั ะฒัะพะดะฝัั, output ะดะปั ะฒััะพะดะฝัั), ัะบะพะฝะพะผะธั ะพั prompt caching (cache write โ 1.25ร, cache read โ 0.1ร ะพั ะฑะฐะทะพะฒะพะน ััะพะธะผะพััะธ), ััะฐัะธััะธะบั ะฟะฐะผััะธ (ะบะพะปะธัะตััะฒะพ ัััะฐะฝะธั, ัะธะผะฒะพะปั ะฝะฐ ะฟะพัะปะตะดะฝะธั ะดะฒัั ัััะฐะฝะธัะฐั ะธ ะฒ raw ัะฒะพััะต)

**Embeddings:**
- Model: BAAI/bge-m3 (1024 dims)
- Normalize: True (ะดะปั cosine similarity)

**Reranker:**
- Model: BAAI/bge-reranker-large
- Device: cuda > mps > cpu (ะฐะฒัะพะพะฟัะตะดะตะปะตะฝะธะต)
- Top N: 10

**Docker Sandbox:**
- ะะฑัะฐะท: Alpine Linux ั Unix ััะธะปะธัะฐะผะธ
- ะะฐะฑะพัะฐั ะดะธัะตะบัะพัะธั: /app (repos ะบะพะฟะธััะตััั ะธะท ะพะฑัะฐะทะฐ)
- ะะตะทะพะฟะฐัะฝะพััั: user="nobody", read_only=True
- ะขะฐะนะผะฐัั: 30 ัะตะบัะฝะด ะฝะฐ ะบะพะผะฐะฝะดั

## ๐๏ธ Troubleshooting

**ES ะฝะต ััะฐัััะตั:**
```bash
sudo chown -R 1000:1000 data/elasticsearch
```

**OOM ะฟัะธ ะธะฝะดะตะบัะฐัะธะธ:**
- ะฃะฒะตะปะธัััะต `ES_JAVA_OPTS=-Xms1g -Xmx2g` ะฒ docker-compose.yml
- ะะฑัะฐะฑะฐััะฒะฐะนัะต ัะฐะนะปั ะฟะพััะธัะผะธ

**Claude API timeout:**
- ะัะพะฒะตัััะต ANTHROPIC_API_KEY ะฒ .env
- ะัะพะฒะตัััะต CLAUDE_MODEL ะฒ .env

**Sandbox ะบะพะผะฐะฝะดั ะฝะต ะฒัะฟะพะปะฝััััั:**
```bash
docker ps  # ะัะพะฒะตัะธัั ััะพ rag-assistant-rag-sandbox-1 ะทะฐะฟััะตะฝ
docker logs rag-assistant-rag-sandbox-1  # ะัะพะฒะตัะธัั ะปะพะณะธ
```

**Docker ะฝะต ะทะฐะฟััะบะฐะตััั:**
```bash
docker compose config  # ะัะพะฒะตัะธัั ะบะพะฝัะธะณััะฐัะธั
docker compose down && docker compose up -d  # ะะตัะตะทะฐะฟััะบ
```

## ๐ ะะธัะตะฝะทะธั

MIT (ะตัะปะธ ะฟัะธะผะตะฝะธะผะพ)

---

**ะฃะดะฐัะฝะพะณะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั! ๐**
