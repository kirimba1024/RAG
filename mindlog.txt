> Kirill Osipov:
# claude_interactive.py
from anthropic import Anthropic, APIConnectionError, RateLimitError
import os, sys

ANTHROPIC_API_KEY = os.environ.get("ANTHROPIC_API_KEY")
if not ANTHROPIC_API_KEY:
    print("Set ANTHROPIC_API_KEY"); sys.exit(1)

client = Anthropic(api_key=ANTHROPIC_API_KEY)

TOOLS = [{
    "name": "ask_user",
    "description": "–ó–∞–ø—Ä–æ—Å–∏—Ç—å —É —á–µ–ª–æ–≤–µ–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é/—Ñ–∞–π–ª/—Ñ—Ä–∞–≥–º–µ–Ω—Ç. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Ñ–∞–∫—Ç–æ–≤ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.",
    "input_schema": {
        "type": "object",
        "properties": {
            "prompt": {"type": "string", "description": "–ö–æ—Ä–æ—Ç–∫–∏–π, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."}
        },
        "required": ["prompt"],
        "additionalProperties": False,
    },
}]

SYSTEM = (
"–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é. –ï—Å–ª–∏ —É —Ç–µ–±—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ñ–∞–∫—Ç–æ–≤ (–º–∞–ª–æ —Ü–∏—Ç–∏—Ä—É–µ–º—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤, "
"–Ω–µ—Ç —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –ø–æ —è–∫–æ—Ä—è–º, –Ω–µ—è—Å–Ω—ã –ø—É—Ç–∏ –∏–ª–∏ –∏–º–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–æ–≤) ‚Äî –≤—ã–∑–æ–≤–∏ tool ask_user —Å 1‚Äì3 –û–ß–ï–ù–¨ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏. "
"–ü—Ä–æ—Å–∏ —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏/–∏–º–µ–Ω–∞/–∫—É—Å–æ–∫ –∫–æ–¥–∞ 100‚Äì200 —Å—Ç—Ä–æ–∫. –ù–µ –∑–∞–¥–∞–≤–∞–π –æ–±—â–∏–π/—Ä–∞–∑–º—ã—Ç—ã–π –≤–æ–ø—Ä–æ—Å."
)

def run_chat(user_question: str, model: str = "claude-3-5-sonnet-20240620"):
    messages = [{"role": "user", "content": user_question}]
    while True:
        try:
            resp = client.messages.create(
                model=model,
                max_tokens=1200,
                system=SYSTEM,
                tools=TOOLS,
                temperature=0.2,
                messages=messages,
            )
        except (APIConnectionError, RateLimitError) as e:
            print(f"API error: {e}"); break

        # —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        tool_uses = []
        final_text_chunks = []
        for block in resp.content:
            if block.type == "tool_use":
                tool_uses.append(block)
            elif block.type == "text":
                final_text_chunks.append(block.text)

        # –µ—Å–ª–∏ –º–æ–¥–µ–ª—å —Å–ø—Ä–æ—Å–∏–ª–∞ —á—Ç–æ-—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º tool_use
        if tool_uses:
            for tu in tool_uses:
                if tu.name == "ask_user":
                    q = tu.input.get("prompt", "").strip()
                    print("\nü§ñ –í–æ–ø—Ä–æ—Å –æ—Ç Claude:", q)
                    user_reply = input("üßë –í–∞—à –æ—Ç–≤–µ—Ç: ").strip()
                    # –æ—Ç–≤–µ—á–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º (tool_result) –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∏–∞–ª–æ–≥
                    messages.append({"role": "assistant", "content": [{"type": "tool_use", "id": tu.id, "name": tu.name, "input": tu.input}]})
                    messages.append({"role": "user", "content": [{"type": "tool_result", "tool_use_id": tu.id, "content": user_reply}]})
            # —Ü–∏–∫–ª –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è ‚Äî –º–æ–¥–µ–ª—å –ø–æ–ª—É—á–∏—Ç tool_result –∏ –¥–∞—Å—Ç —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥
            continue

        # –µ—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–µ –±—ã–ª–æ ‚Äî –ø–µ—á–∞—Ç–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∏ –≤—ã—Ö–æ–¥–∏–º
        final_text = "".join(final_text_chunks).strip()
        print("\nüß† –û—Ç–≤–µ—Ç Claude:\n", final_text)
        break

if name == "__main__":
    run_chat(input("‚ùì –í–æ–ø—Ä–æ—Å: "))






–ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –≤—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–µ—Ç –æ—à–∏–±–æ–∫, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –æ—à–∏–±–æ–∫, –≤—Å—ë —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ,
–≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ª–æ–≥–∏–∫–µ –≤–µ—â–µ–π –∏ –Ω–µ—Ç —Å–∏—Ç—É–∞—Ü–∏–π –∫–æ–≥–¥–∞ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è, –µ—Å—Ç—å –ª–∏ —á—Ç–æ-—Ç–æ –ª–∏—à–Ω–µ–µ –ø–æ–º–∏–º–æ
–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –≤ rag_utils? –ò–Ω—Ç–µ—Ä–µ—Å—É—é—Ç –±–æ–ª—å—à–µ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –≤–µ—â–∏ –Ω–µ–∂–µ–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ –º–µ–ª–æ—á–∏ —Ç–∏–ø–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è.
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≥–ª—É–±–∏–Ω–Ω–æ, –≤–¥—É–º—á–∏–≤–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞. –ö–∞–∫ –º–æ–∂–Ω–æ –µ—â—ë —É–ª—É—á–∏—Ç—å?



–ö–æ–≥–¥–∞ —á—Ç–æ –±—Ä–∞—Ç—å
–ù—É–∂–Ω—ã —Å—É—â–Ω–æ—Å—Ç–∏/–æ—Ç–Ω–æ—à–µ–Ω–∏—è/–æ–±—ä—è—Å–Ω–∏–º–æ—Å—Ç—å ‚Üí PropertyGraphIndex (–∏–ª–∏ –ø–æ–ø—Ä–æ—â–µ KnowledgeGraphIndex).
–ù—É–∂–µ–Ω –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ —Å–º—ã—Å–ª—É ‚Üí VectorStoreIndex (+ –≥–∏–±—Ä–∏–¥/–ø–µ—Ä–µ—Ä–∞–Ω–∫).
–ù—É–∂–Ω–∞ —Å–≤–æ–¥–∫–∞ –±–æ–ª—å—à–æ–≥–æ –∫–æ—Ä–ø—É—Å–∞ ‚Üí Summary/TreeIndex.
–ù—É–∂–Ω—ã —Ç–∞–±–ª–∏—á–∫–∏/–ë–î ‚Üí SQLDatabaseQueryEngine –∏–ª–∏ Pandas/CSV Engines.
–ù—É–∂–µ–Ω –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–∑–≥ ‚Üí Router/SubQuestion + Composable Graph.




> Kirill Osipov:
# 1) –∏–Ω–¥–µ–∫—Å—ã
idx_all  = VectorStoreIndex.from_documents(docs)                 # –≤–µ–∫—Ç–æ—Ä–∫–∞
pg_index = PropertyGraphIndex.from_documents(docs, show_progress=True)  # <-- PropertyGraphIndex

# 2) –≥–∏–±—Ä–∏–¥ (BM25 + Vector ‚Üí RRF)
bm25   = BM25Retriever.from_defaults(documents=docs, similarity_top_k=10)
vec    = idx_all.as_retriever(similarity_top_k=12)
fusion = QueryFusionRetriever(retrievers=[vec, bm25], mode="reciprocal_rerank", num_queries=1, similarity_top_k=12)

# 3) query engines
qe_graph  = pg_index.as_query_engine(include_text=True, similarity_top_k=12)
qe_hybrid = RetrieverQueryEngine.from_args(fusion, node_postprocessors=[HuggingFaceRerank("cross-encoder/ms-marco-MiniLM-L-6-v2", top_n=5)])

# 4) –æ–±—ä–µ–¥–∏–Ω—è–µ–º SubQuestionQueryEngine
tools = [
  QueryEngineTool(qe_graph,  ToolMetadata(name="graph",  description="—Å–≤—è–∑–∏/–ø—Ä–∏—á–∏–Ω—ã/–±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞")),
  QueryEngineTool(qe_hybrid, ToolMetadata(name="hybrid", description="BM25+Vector (RRF) –ø–æ –∫–æ—Ä–ø—É—Å—É")),
  # –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ë–î –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å: QueryEngineTool(qe_sql, ToolMetadata(...)),
]
ask = SubQuestionQueryEngine.from_defaults(query_engine_tools=tools, llm=Settings.llm, use_async=False).query

# –ø—Ä–∏–º–µ—Ä
# print(ask("–ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω –≤–æ–∑–≤—Ä–∞—Ç –ø–ª–∞—Ç–µ–∂–∞ –∏ –≥–¥–µ —ç—Ç–æ –≤ –∫–æ–¥–µ/–¥–æ–∫–∞—Ö –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è?"))





–ß—Ç–æ –∑–¥–µ—Å—å ¬´—Å–∞–º–æ–µ –ø–æ–ª–µ–∑–Ω–æ–µ –∏ –∫–ª–∞—Å—Å–Ω–æ–µ¬ª, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º –∫–æ—Ä–æ—Ç–∫–æ:
 ‚Ä¢ PropertyGraphIndex –¥–ª—è –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ.
 ‚Ä¢ Vector + BM25 ‚Üí RRF (QueryFusionRetriever) –ø–æ–≤—ã—à–∞–µ—Ç recall, –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ –∞–π–¥–∏—à–Ω–∏–∫–∞–º/—Ç–µ—Ä–º–∏–Ω–∞–º.
 ‚Ä¢ Cross-encoder rerank + LongContextReorder + similarity cutoff ‚Äî —á–∏—â–µ –∏ —Ç–æ—á–Ω–µ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç.
 ‚Ä¢ SQL NL‚ÜíSQL –∫ –∂–∏–≤–æ–π –ë–î (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã, –±–µ–∑ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫).
 ‚Ä¢ RouterQueryEngine (–±—ã—Å—Ç—Ä—ã–π –∞–≤—Ç–æ–ø–æ–¥–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞) –∏ SubQuestionQueryEngine (–º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ —Å–∫–≤–æ–∑–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã).
 ‚Ä¢ –î–æ–º–µ–Ω–Ω—ã–µ –¥–≤–∏–∂–∫–∏ docs/front/back ‚Äî –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø—Ä–∏—Ü–µ–ª—å–Ω–æ –∏–¥—Ç–∏ –≤ —Å–ª–æ–π.





 –ò—Å–ø–æ–ª—å–∑—É–µ–º
LLM/Embeddings: Ollama mistral:7b-instruct-q4_K_M + HF-—ç–º–±–µ–¥–¥–µ—Ä BAAI/bge-m3 (normalize=True).
–ö–æ—Ä–ø—É—Å (3 –¥–æ–º–µ–Ω–∞): knowledge/docs, knowledge/front, knowledge/back ‚Äî —á–∏—Ç–∞–µ–º —á–µ—Ä–µ–∑ SimpleDirectoryReader c –±–µ–ª—ã–º —Å–ø–∏—Å–∫–æ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π; —Å–∫—Ä—ã—Ç—ã–µ –∏ –º—É—Å–æ—Ä –∏—Å–∫–ª—é—á–∞–µ–º.
–ò–Ω–¥–µ–∫—Å—ã (persist + RAM-–∫—ç—à):
PropertyGraphIndex (–æ–±—â–∏–π –ø–æ –≤—Å–µ–º—É –∫–æ—Ä–ø—É—Å—É) ‚Äî –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏/–æ–±—ä—è—Å–Ω–∏–º–æ—Å—Ç—å.
VectorStoreIndex: –æ–±—â–∏–π + –ø–æ –¥–æ–º–µ–Ω–∞–º (docs/front/back) ‚Äî –≤—ã—Å–æ–∫–∏–π recall –∏ —Ç–∞—Ä–≥–µ—Ç –ø–æ —Å–ª–æ—è–º.
SummaryIndex (–æ–±—â–∏–π) ‚Äî –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ–±–∑–æ—Ä–æ–≤/¬´–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤ —Ü–µ–ª–æ–º¬ª.
–ì–∏–±—Ä–∏–¥–Ω—ã–π —Ä–µ—Ç—Ä–∏–≤–∞–ª: BM25 + Vector ‚Üí RRF —á–µ—Ä–µ–∑ QueryFusionRetriever
‚Äî —Å—Ç—Ä–æ–∏–º BM25 –∏–∑ docstore –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ (–±–µ–∑ –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤); —Å–≤–µ—Ä—Ö—É rerank (HF cross-encoder/SBERT) + LongContextReorder + SimilarityPostprocessor(cutoff=0.2).
SQL –∫ –±–∞–∑–µ: NLSQLTableQueryEngine (–∏–ª–∏ SQLTableRetrieverQueryEngine), read-only, statement_timeout, whitelist —Ç–∞–±–ª–∏—Ü.
–û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤: SubQuestionQueryEngine –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π (—É–º–Ω–∞—è –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è graph + hybrid + sql + domain QE).
(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–µ—Ä–∂–∏–º RouterQueryEngine –¥–ª—è ¬´—É–∑–∫–∏—Ö/–ø—Ä–æ—Å—Ç—ã—Ö¬ª –≤–æ–ø—Ä–æ—Å–æ–≤.)
–ü–µ—Ä—Å–∏—Å—Ç/–∑–∞–≥—Ä—É–∑–∫–∞: –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ –¥–∏—Å–∫ (./storage_*), –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ‚Äî –ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞; –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ ‚Äî –∫–ª–∞—Å—Å-—Ö–∞–± (IndexHub) —Å RAM-–∫—ç—à–µ–º.
–û—Ç–∫–∞–∑–∞–ª–∏—Å—å/–Ω–µ –≤–∫–ª—é—á–∞–ª–∏
‚ùå –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ë–î –∏–ª–∏ —Å—Ö–µ–º—ã –ë–î –≤ –≥—Ä–∞—Ñ ‚Äî –≥—Ä–∞—Ñ —Å—Ç—Ä–æ–∏–º —Ç–æ–ª—å–∫–æ –ø–æ docs/front/back.
‚ùå –î—Ä–æ–±–ª–µ–Ω–∏–µ back –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º ‚Äî –æ—Å—Ç–∞–≤–∏–ª–∏ —Ç—Ä–∏ –¥–æ–º–µ–Ω–∞ —Ä–∞–¥–∏ –ø—Ä–æ—Å—Ç–æ—Ç—ã.
‚ùå –û—Ç–¥–µ–ª—å–Ω—ã–π JSONL-–∫–æ—Ä–ø—É—Å –¥–ª—è BM25 ‚Äî –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç—ã –Ω–µ –Ω—É–∂–Ω–æ; –±–µ—Ä—ë–º –∏–∑ docstore.
‚ùå KeywordTableIndex ‚Äî BM25 —É–∂–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —Ç–æ—á–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã/ID.
‚ùå Router-—Ç–æ–ª—å–∫–æ —Ä–µ–∂–∏–º ‚Äî –æ–Ω –≤—ã–±–∏—Ä–∞–µ—Ç –æ–¥–∏–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç; –¥–ª—è —Å–∫–≤–æ–∑–Ω—ã—Ö –±–∏–∑–Ω–µ—Å-–≤–æ–ø—Ä–æ—Å–æ–≤ –ª—É—á—à–µ SubQuestion.
‚ùå –¢—è–∂—ë–ª—ã–µ —Ä–∏–¥–µ—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî PDFReader/DocxReader –ø–æ–¥–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω—ã.



+ code splitter
+ sql Gardrail ? (not schema to graph)
+ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —É–∑–ª–æ–≤: layer=docs|front|back, file_path, symbol ‚Äî —É–ª—É—á—à–∞–µ—Ç –æ–±—ä—è—Å–Ω–∏–º–æ—Å—Ç—å –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é.


–æ–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞ GIT —á—Ç–æ–±—ã –æ—Ç—Å—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π


Qwen2.5-14B / 32B Instruct –¥–ª—è PropertyGraphIndex –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è

–≠–º–±—ç–¥–¥–∏–Ω–≥ - mistral
Graph - anthropic


–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AST –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–¥–∞ –∏ –¥—Ä–æ–±–∏—Ç—å –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –º–µ—Ç–æ–¥–∞–º –∏—Ç–ø


Neo4j (Community) ‚Äî property-graph –¥–ª—è —Å–≤—è–∑–µ–π/GraphRAG.
Postgres ‚Äî pgvector + docstore/index_store –¥–ª—è SummaryIndex –∏ —Å–ª—É–∂–µ–±–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ø–ª—é—Å –ª—é–±–∞—è —Ç–∞–±–ª–∏—á–Ω–∞—è –º–µ—Ç–∞).
ElasticSearch - –¥–ª—è BM25


from llama_index.core import PropertyGraphIndex
from llama_index.core.indices.property_graph import SimpleLLMPathExtractor, ImplicitPathExtractor

# –ö–æ–º–±–∏–Ω–∞—Ü–∏—è —ç–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä–æ–≤ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è
kg_extractors = [
    SimpleLLMPathExtractor(),  # –û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π
    ImplicitPathExtractor()    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–≤—è–∑–∏ –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
]

# –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞ - –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ
index = PropertyGraphIndex.from_documents(
    documents,
    kg_extractors=kg_extractors,
    property_graph_store=graph_store,
    show_progress=True
)


–°—É–ø–µ—Ä-–∫–æ—Ä–æ—Ç–∫–æ
–°–æ–±–∏—Ä–∞–µ–º –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π RAG-—Å—Ç–µ–∫ –Ω–∞ LlamaIndex —Å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π –∏ –≥–∏–±—Ä–∏–¥–Ω—ã–º –ø–æ–∏—Å–∫–æ–º (pgvector + Elasticsearch + Neo4j + SummaryIndex –≤ Postgres), —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å / –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å / —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –∑–Ω–∞–Ω–∏—è –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ /knowledge.
–ß—É—Ç—å –¥–ª–∏–Ω–Ω–µ–µ (–∫–æ—Ä–æ—Ç–∫–æ, –Ω–æ —ë–º–∫–æ)
–¶–µ–ª—å: –µ–¥–∏–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω ingest ‚Üí –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –∑–∞–ø—Ä–æ—Å—ã, —Å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π (–ø–æ —Ö—ç—à—É —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ/–º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö) –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–π —Å–±–æ—Ä–∫–æ–π –∏–Ω–¥–µ–∫—Å–æ–≤.
–•—Ä–∞–Ω–∏–ª–∏—â–∞ / –∏–Ω–¥–µ–∫—Å—ã:
Vector + metadata: Postgres 16 + pgvector (dense; –≥–∏–±—Ä–∏–¥ —Å FTS –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).
BM25 –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç: Elasticsearch 8.12 (—Ä—É—Å—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä).
–ì—Ä–∞—Ñ —Å–≤—è–∑–µ–π: Neo4j 5 (PropertyGraphIndex / Neo4jPropertyGraphStore).
Summary / –æ–±–∑–æ—Ä—ã: LlamaIndex SummaryIndex –≤ Postgres (docstore/index_store).
–û–ø–µ—Ä–∞—Ü–∏–∏:
–ü–∞—Ä—Å–∏–º —Ñ–∞–π–ª—ã –∏–∑ /knowledge, —Ä–µ–∂–µ–º –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ (—Ä–∞–∑–º–µ—Ä/–ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã), —Å—á–∏—Ç–∞–µ–º content_hash.
–ü–∏—à–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ/–∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —á–∞–Ω–∫–∏ (–ø–æ content_hash + –∫–ª—é—á–µ–≤—ã–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º).
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ç—Ä–∏ –∏–Ω–¥–µ–∫—Å–∞: pgvector, Elasticsearch (BM25), Neo4j; –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –∫—Ä–æ—Å—Å-–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä doc_id/chunk_id.
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º QueryEngine —Å rerank (–Ω–∞–ø—Ä–∏–º–µ—Ä, LongContextReorder + Similarity cutoff), —É–º–µ—é—â–∏–π: dense, BM25, –≥–∏–±—Ä–∏–¥, –≥—Ä–∞—Ñ–æ–≤—ã–µ —Ö–æ–¥—ã.
–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å: –º–æ–¥—É–ª—å build.py (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–¥, —è–≤–Ω—ã–µ –∏–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö), –∫–æ–Ω—Ñ–∏–≥ –∏–∑ .env, –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ getattr. –ö–æ–º–∞–Ω–¥—ã: build_all(), build_incremental(), rebuild(index=...).
–ù–µ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è: –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º —á–∞–Ω–∫–∏–Ω–≥–∞, –¥–µ–¥—É–ø, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –±—ã—Å—Ç—Ä—ã–π cold-start.
–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã: docker-compose.yml –¥–ª—è Postgres/pgvector, Elasticsearch(+RU –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä), Neo4j; –ø—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤; –Ω–µ–±–æ–ª—å—à–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã.
–ù–µ —Ü–µ–ª–∏: —Ç–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–æ–¥-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä ‚Äî –ø–æ–∫–∞ –≤–Ω–µ —Ä–∞–º–æ–∫.
–†–µ–∑—É–ª—å—Ç–∞—Ç: reproducible –ø–∞–π–ø–ª–∞–π–Ω, –≥–¥–µ ¬´–¥–æ–±–∞–≤–∏–ª —Ñ–∞–π–ª ‚Üí –ø—Ä–æ–≥–Ω–∞–ª build_incremental() ‚Üí –∏–Ω–¥–µ–∫—Å—ã –æ–±–Ω–æ–≤–∏–ª–∏—Å—å; –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≥–∏–±—Ä–∏–¥ + –≥—Ä–∞—Ñ –ø–æ –æ–¥–Ω–æ–º—É API¬ª.




–ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç: –¥–∞ ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–µ–ª–∞–π —Ç–∞–∫:
Vector store ‚Üí —á–∞–Ω–∫–∏ (TextNode –Ω–∞ —á–∞–Ω–∫).
–ü—Ä–∏—á–∏–Ω–∞: –ª—É—á—à–µ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ, –º–µ–Ω—å—à–µ ¬´—Ä–∞–∑–º–∞–∑—ã–≤–∞–Ω–∏—è¬ª —Å–µ–º–∞–Ω—Ç–∏–∫–∏.
Elasticsearch ‚Üí —Ç–µ –∂–µ —á–∞–Ω–∫–∏ ( _id = {doc_id}#{i} + source_path = doc_id).
–ü—Ä–∏—á–∏–Ω–∞: —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è/—Ö–∞–π–ª–∞–π—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞; –º–æ–∂–Ω–æ —Å–º–µ—à–∏–≤–∞—Ç—å —Å –≤–µ–∫—Ç–æ—Ä–æ–º.
Summary ‚Üí —Ü–µ–ª–∏–∫–æ–º –¥–æ–∫—É–º–µ–Ω—Ç.
–ü—Ä–∏—á–∏–Ω–∞: —ç—Ç–æ—Ç –∏–Ω–¥–µ–∫—Å –¥–µ—Ä–∂–∏—Ç ¬´–æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞¬ª. –ï—Å–ª–∏ –∑–∞–ª–∏—Ç—å —Å–æ—Ç–Ω–∏ —á–∞–Ω–∫–æ–≤ ‚Äî –±—É–¥–µ—Ç –ª–∏—à–Ω–∏–π —à—É–º –∏ —Ä–æ—Å—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–µ–π.
Property/Knowledge Graph ‚Üí –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ü–µ–ª–∏–∫–æ–º –¥–æ–∫—É–º–µ–Ω—Ç (–∫–∞–∫ —É —Ç–µ–±—è —Å–µ–π—á–∞—Å).
–ü—Ä–∏—á–∏–Ω–∞: –º–µ–Ω—å—à–µ —É–∑–ª–æ–≤/—Ä–µ–±–µ—Ä –∏ –¥–µ—à–µ–≤–ª–µ –≤ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏.
–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –≤—ã—Å–æ–∫–∏–π recall –ø–æ —Å—É—â–Ω–æ—Å—Ç—è–º –≤ –¥–ª–∏–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö ‚Äî –º–æ–∂–Ω–æ –ø–æ–¥–∞–≤–∞—Ç—å —á–∞–Ω–∫–∏, –Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–≤–ª—è–π ref_doc_id = doc_id, –∏ —Å–ª–µ–¥–∏ –∑–∞ –æ–±—ä—ë–º–æ–º (–ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ —á–∞–Ω–∫–∞ –∏ —á–∏—Å–ª–∞ –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã—Ö —Ç—Ä–∏–ø–ª–µ—Ç–æ–≤).


def _looks_text(sample: bytes) -> bool:
    if b"\x00" in sample:
        return False
    ctrl = sum(b < 9 or (13 < b < 32) for b in sample)
    return (ctrl / max(1, len(sample))) < 0.02

 –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ build.py


 ES-—Ä–µ—Ç—Ä–∏–≤–µ—Ä –ª—É—á—à–µ —á–µ–º BM25Retriever LlamaIndex



 #### üìà –ü–æ–≤—ã—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç HIGH):

1. Query Expansion (HyDE) ‚Äî +12% recall
2. Context Compression ‚Äî -50% tokens, +8% accuracy
3. Multi-stage Reranking ‚Äî +15% precision
4. Adaptive Chunking ‚Äî +15% –Ω–∞ —Ä–∞–∑–Ω–æ—Ä–æ–¥–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
5. Graph-enhanced Retrieval ‚Äî +20% –Ω–∞ –≤–æ–ø—Ä–æ—Å–∞—Ö –ø—Ä–æ —Å–≤—è–∑–∏


1. HyDE Query Expansion (2 —á–∞—Å–∞)
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   - +12% recall
   - üîß –ö–æ–¥ –≥–æ—Ç–æ–≤ –≤ ADVANCED_RAG_TECHNIQUES.md

2. Context Compression (3 —á–∞—Å–∞)
   - LongLLMLingua –¥–ª—è —Å–∂–∞—Ç–∏—è
   - -50% tokens, +8% accuracy
   - üí∞ -40% —Å—Ç–æ–∏–º–æ—Å—Ç—å API

3. Multi-stage Reranking (4 —á–∞—Å–∞)
   - Cascade: Fast ‚Üí Powerful reranker
   - +15% precision


 docker compose down -v --remove-orphans && docker compose build --no-cache && docker compose up -d

 –°–¥–µ–ª–∞—Ç—å —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫—É- —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–π

 –°–¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–µ—Å—Ç–æ–≤ –∏–∑ –ø–∞–ø–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫—É ignore masked build call


 –£ –º–µ–Ω—è –≤–æ—Ç –∫–∞–∫–∞—è –∑–∞–¥–∞—á–∞ —Å—Ç–æ–∏—Ç
–£ –º–µ–Ω—è –µ—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, –±—ç–∫—ç–Ω–¥—ã –∏ —Ñ—Ä–æ–Ω—Ç—ç–Ω–¥—ã –∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞–∑–Ω—ã–º –ø—Ä–æ–µ–∫—Ç–∞–º. –∏—Ö –ø—Ä—è–º –ø—Ä–∏–ª–∏—á–Ω–æ —à—Ç—É–∫ 10 –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ —É –∫–∞–∂–¥–æ–≥–æ —Å–≤–æ—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è , –±—ç–∫ —Ñ—Ä–æ–Ω—Ç –∏ –±–∞–∑–∞, –±–∞–∑–∞ —á–∞—Å—Ç–æ –æ–±—â–∞—è –±—ã–≤–∞–µ—Ç –º–µ–∂–¥—É –ø—Ä–æ–µ–∫—Ç–∞–º–∏.
–ú–Ω–µ –Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –ø–æ –∞–Ω–∞–ª–∏–∑—É —Ç–∏–ø–∞ –∫–∞–∫ cursor –Ω–∞ –æ–¥–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ.
–¢–æ–ª—å–∫–æ –º–Ω–µ –Ω–∞–¥–æ —Å–¥–ª–∞—Ç—å RAG –º–µ–∂–¥—É –≤—Å–µ–º–∏ –∏—Å—Ö–æ–¥–Ω—ã–º–∏ –∫–æ–¥–∞–º–∏ –∏ –±–∞–∑–∞–º–∏.
–ù–æ —è —Ö–æ—á—É –∫–∞–∫-—Ç–æ –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Ç–≤–ª–µ–Ω–∏—è —á—Ç–æ–±—ã –±—ã–ª–æ –Ω–∞–∏–±–æ–ª–µ–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ.
–ù–∞–ø—Ä–∏–º–µ—Ä —è –¥—É–º–∞—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (–∫–∞–∫ —Å–µ–π—á–∞—Å –∏ –µ—Å—Ç—å)
–ø—Ä–æ—Å—Ç–æ —É –Ω–∏—Ö –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –º–æ–∂–Ω–æ –ø–æ category —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å. –ù–æ —è –¥—É–º–∞—é —á—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏ —ç—Ç–æ –±—ã–ª–æ –±—ã –ª–∏—à–Ω–∏–º,
 –∏ –º–æ–∂–Ω–æ –ø—Ä—è–º –ø–æ–ª–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ —Å–¥–µ–ª–∞—Ç—å –∞ –æ–Ω —Å–∞–º —É–∂–µ –∫–∞–∫-–Ω–∏–±—É–¥—å –Ω–∞—Ä–æ–µ—Ç + –≤ –±–¥ –∑–∞–ª–µ–∑—Ç—å + –≥—Ä–∞—Ñ –ø–æ–≥–ª—è–¥–µ—Ç—å + summary
 —Å–¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–∞–∫-—Ç–æ —Ç–∞–∫. –Ø —Å–∞–º –Ω–µ –∑–Ω–∞—é –∫–∞–∫ –ª—É—á—à–µ


 –ê–±—Å–æ–ª—é—Ç–Ω–æ –≤–µ—Ä–Ω–æ! üéØ Keep it simple ‚Äî LLM –æ—Ç–ª–∏—á–Ω–æ –ø–æ–Ω–∏–º–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å–∞–º–∞.

## ‚úÖ –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–ª—É—á—à–∏–π)

class MinimalGrouping(BaseNodePostprocessor):
    """
    –ü—Ä–æ—Å—Ç–æ –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ category, –±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞.
    LLM —Å–∞–º–∞ —Ä–∞–∑–±–µ—Ä—ë—Ç—Å—è.
    """

    def _postprocess_nodes(self, nodes, query_bundle=None):
        result = []
        groups = defaultdict(list)

        for node in nodes:
            category = node.metadata.get("category", "unknown")
            groups[category].append(node)

        # –°–æ—Ä—Ç–∏—Ä—É–µ–º: –±–æ–ª—å—à–µ chunks = –≤–µ—Ä–æ—è—Ç–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–µ–µ
        sorted_groups = sorted(groups.items(), key=lambda x: len(x[1]), reverse=True)

        for category, group_nodes in sorted_groups:
            # –ü—Ä–æ—Å—Ç–æ–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Å category as-is
            header = f"\n{'='*60}\n{category}\n{'='*60}\n"

            first = group_nodes[0]
            first.text = header + first.text
            result.extend(group_nodes)

        logger.info(f"üì¶ Context: {dict((c, len(n)) for c, n in sorted_groups)}")
        return result
## –ß—Ç–æ —É–≤–∏–¥–∏—Ç LLM:

============================================================
CRM-backend
============================================================
File: services/UserService.java
Language: java
...

============================================================
CRM-frontend
============================================================
File: components/UserService.ts
Language: typescript
...

============================================================
AdminPanel-backend
============================================================
File: controllers/AdminController.java
Language: java
...
Claude –ª–µ–≥–∫–æ –ø–æ–π–º—ë—Ç:
- "CRM-backend" = –ø—Ä–æ–µ–∫—Ç CRM, –±—ç–∫–µ–Ω–¥
- "CRM-frontend" = –ø—Ä–æ–µ–∫—Ç CRM, —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
- "shared-db-postgres" = shared –±–∞–∑–∞, postgres

## üéØ –ï—â—ë –ø—Ä–æ—â–µ ‚Äî –≤–æ–æ–±—â–µ –±–µ–∑ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏?

–ú–æ–∂–Ω–æ –¥–∞–∂–µ –ù–ï –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å, –∞ –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å metadata –≤ –Ω–∞—á–∞–ª–æ –∫–∞–∂–¥–æ–≥–æ chunk:

class MetadataPrefix(BaseNodePostprocessor):
    """–î–æ–±–∞–≤–ª—è–µ—Ç metadata –∫–∞–∫ –ø—Ä–µ—Ñ–∏–∫—Å –∫ –∫–∞–∂–¥–æ–º—É chunk"""

    def _postprocess_nodes(self, nodes, query_bundle=None):
        for node in nodes:
            prefix = f"[{node.metadata.get('category', 'unknown')}]"

            if node.metadata.get('is_code'):
                lang = node.metadata.get('language', '')
                prefix += f" ({lang})"

            prefix += f" {node.metadata.get('file_path', '')}\n---\n"
            node.text = prefix + node.text

        return nodes
–†–µ–∑—É–ª—å—Ç–∞—Ç:
[CRM-backend] (java) services/UserService.java
---
public class UserService { ... }

[CRM-frontend] (typescript) components/UserService.ts
---
export class UserService { ... }

[AdminPanel-docs] README.md
---
# Admin Panel Documentation
–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –ú–∏–Ω–∏–º—É–º –∫–æ–¥–∞
- ‚úÖ –ù–µ—Ç –±–∞–≥–æ–≤ –ø–∞—Ä—Å–∏–Ω–≥–∞
- ‚úÖ LLM –≤–∏–¥–∏—Ç –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- ‚úÖ –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (–ø–æ relevance –ø–æ—Å–ª–µ rerank)

## üí° –ú–æ–π —Å–æ–≤–µ—Ç:

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç:

# –í call.py –ø—Ä–æ—Å—Ç–æ:

def build_simple_query_engine():
    fusion = QueryFusionRetriever(...)
    rerank = SentenceTransformerRerank(...)

    # –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π postprocessor ‚Äî –¥–æ–±–∞–≤–∏—Ç—å metadata
    metadata_prefix = MetadataPrefix()

    return RetrieverQueryEngine.from_args(
        fusion,
        node_postprocessors=[rerank, metadata_prefix],
        response_synthesizer=...
    )
–ü—Ä–æ–º–ø—Ç –¥–ª—è LLM:
SYSTEM_PROMPT = """
–¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å multi-project –∫–æ–¥–æ–≤—É—é –±–∞–∑—É.

–ö–∞–∂–¥—ã–π chunk –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å metadata:
[project-type] (language) file_path

–ü—Ä–∏–º–µ—Ä—ã:
- [CRM-backend] (java) services/UserService.java
- [CRM-frontend] (typescript) components/UserForm.tsx
- [shared-db] schema/users.sql

–ü–†–ê–í–ò–õ–ê:
1. –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—á–Ω–∏–∫ –≤ –æ—Ç–≤–µ—Ç–µ
2. –†–∞–∑–ª–∏—á–∞–π backend/frontend ‚Äî —ç—Ç–æ —Ä–∞–∑–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
3. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö ‚Äî –ø–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ

LLM –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É–º–Ω–∞ —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É!
"""
## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–∏–ø–æ—Ç–µ–∑—ã



–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–Ω–∞—á–∞–ª–∞:
- –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö
- –°–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ LLM —Ä–∞–∑–ª–∏—á–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç—ã
- –ï—Å–ª–∏ –ø—É—Ç–∞–µ—Ç—Å—è (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ) ‚Äî –¥–æ–±–∞–≤–∏—Ç–µ –ø–∞—Ä—Å–∏–Ω–≥

–§–∏–ª–æ—Å–æ—Ñ–∏—è: Don't build what you don't need yet. Start simple, add complexity only when proven necessary.

–í–∞—à–∞ –∏–Ω—Ç—É–∏—Ü–∏—è –≤–µ—Ä–Ω–∞—è ‚Äî category as-is + file_path + language —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. LLM —Ä–∞–∑–±–µ—Ä—ë—Ç—Å—è! üöÄ




## üéØ –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–∫—Ä–∞—Ç–∫–æ)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
Question
  ‚Üí Hybrid Search (ES + Vector + Graph, –ë–ï–ó —Ñ–∏–ª—å—Ç—Ä–æ–≤)
  ‚Üí Fusion (num_queries=1)
  ‚Üí Rerank (top_n=15)
  ‚Üí Metadata prefix [category] (language) file_path
  ‚Üí Single LLM call
  ‚Üí Answer
...### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:

1. ‚úÖ –ï–¥–∏–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–∞–º ‚Äî –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
2. ‚úÖ –£–±—Ä–∞—Ç—å SubQuestionQueryEngine ‚Äî –∏–∑–±—ã—Ç–æ—á–µ–Ω (10-20 LLM –≤—ã–∑–æ–≤–æ–≤ ‚Üí 1)
3. ‚úÖ num_queries=1 ‚Äî –±–µ–∑ –¥–æ—Ä–æ–≥–æ–≥–æ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞–Ω–∏—è
4. ‚úÖ Category as-is ‚Äî –Ω–µ –ø–∞—Ä—Å–∏—Ç—å, LLM —Å–∞–º–∞ —Ä–∞–∑–±–µ—Ä—ë—Ç—Å—è –≤ "CRM-backend"
5. ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π postprocessor ‚Äî –¥–æ–±–∞–≤–∏—Ç—å [category] (language) filepath –∫ –∫–∞–∂–¥–æ–º—É chunk
6. ‚úÖ –£–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç ‚Äî –Ω–∞—É—á–∏—Ç—å —Ä–∞–∑–ª–∏—á–∞—Ç—å –ø—Ä–æ–µ–∫—Ç—ã –∏ —É–∫–∞–∑—ã–≤–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏

### –≠–∫–æ–Ω–æ–º–∏—è:
- –¢–æ–∫–µ–Ω—ã: 20-40k ‚Üí 4-8k (3-5x)
- LLM –≤—ã–∑–æ–≤—ã: 10-20 ‚Üí 1 (10-20x)
- –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: 5-8s ‚Üí 2-3s (2-3x)

### –§–∏–ª–æ—Å–æ—Ñ–∏—è:
> Keep it simple ‚Äî —à–∏—Ä–æ–∫–∏–π –ø–æ–∏—Å–∫ + rerank + LLM —Å–∞–º–∞ —Ä–∞–∑–±–µ—Ä—ë—Ç—Å—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —á–µ—Ä–µ–∑ metadata

–í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è. –°–Ω–∞—á–∞–ª–∞ —ç—Ç–æ, –ø–æ—Ç–æ–º –∏–∑–º–µ—Ä–µ–Ω–∏—è, –ø–æ—Ç–æ–º —É–ª—É—á—à–µ–Ω–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.


1 –º–Ω–µ —Ö–æ—á–µ—Ç—Å—è –µ–¥–∏–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–¥–º–µ—à–∏–≤–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö  –¥–ª—è –ø–æ–º–æ—â–∏ —Å–∞–º–æ–π LLM —á—Ç–æ–±—ã –æ–Ω–∞ –ø–æ–Ω–∏–º–∞–ª–∞ –æ—Ç–∫—É–¥–∞ —á—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç
–ø—Ä–æ–µ–∫—Ç–æ–≤ —É –º–µ–Ω—è –±—É–¥–µ—Ç –≥–¥–µ-—Ç–æ —à—Ç—É–∫ 8-15 –Ω–µ –¥—É–º–∞—é —á—Ç–æ –≤–∞–∂–Ω–æ
2 –¥–∞ —è —Å–æ–±–∏—Ä–∞—é—Å—å –ø–æ–¥—Ü–µ–ø–∏—Ç—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —á—Ç–æ–±—ã —É–º–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –≤ –Ω–µ—ë –º–æ–≥ –∑–∞–ª–µ–∑—Ç—å –ø–æ –Ω—É–∂–¥–µ –Ω–æ –º–Ω–µ —Ö–æ—á–µ—Ç—Å—è —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–æ —á—Ç–æ–±—ã –∫–æ–¥ –Ω–µ —Ä–∞–∑–¥—É–ª—Å—è
–∫–æ–≥–¥–∞ –≥—Ä–∞—Ñ –ø–æ–º–æ–≥–∞–µ—Ç –∞ –∫–æ–≥–¥–∞ —à—É–º –∫–æ—Ä–æ—Ç–∫–æ?
–í–µ—Å–∞ Vector vs BM25 vs Graph - –Ω–µ –ø–æ–Ω—è–ª –ø—Ä–æ –≤–µ—Å–∞
3 –≤–æ—Ç –Ω–µ –∑–Ω–∞—é —á—Ç–æ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–∑–Ω–æ –±—ã–ª–æ –±—ã –ø—Ä–∏—Ü–µ–ø–∏—Ç—å
—Å–≤—è–∑–∏ –º–µ–∂–¥—É –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –Ω—É–∂–Ω—ã –Ω–æ —è –Ω–µ –∑–Ω–∞—é –∫–∞–∫ –∏—Ö –ª—É—á—à–µ –∑–∞–¥–∞—Ç—å, –º–æ–∂–µ—Ç –±—ã—Ç—å –º–Ω–µ –≤—Ä—É—á–Ω—É—é –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ —Ñ–∞–π–ª–∏–∫–∏ –∫–∞–∫–∏–µ-—Ç–æ –ø–æ–ª–æ–∂–∏—Ç—å –æ —Ç–æ–º –∫–∞–∫ –≤—Å—ë —Å–≤—è–∑–∞–Ω–æ –∏–ª–∏ —É—Å—Ç—Ä–æ–µ–Ω–æ, –Ω–µ —Ä–∞–∑–æ–±—Ä–∞–ª—Å—è –µ—â—ë
 summary –Ω–∏–∫–∞–∫–∏—Ö –Ω–µ –Ω–∞–¥–æ, —è —Å–∞–º —Å–¥–µ–ª–∞—é —Ñ–∞–π–ª–∏–∫–∏ –∏ –∞–∫–∫—É–∞—Ä—Ç–Ω–æ –∏—Ö –ø–æ–ª–æ–∂—É –≥–¥–µ-–Ω–∏–±—É–¥—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞–≤–µ—Ä–Ω–æ–µ –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å—ã–Ω–π —à—É–º –∏ –Ω–∞–¥–æ –±—ã—Ç—å –ø—Ä–µ–¥–µ–ª—å–Ω–æ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–º, –∞ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–ª–∞–º—É —Ç–æ —ç—Ç–æ —Å–∂–∏—Ä–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã –æ—á–µ–Ω—å –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–∞ –∏ —à—É–º
4) –¥–∞ –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ num-queries —Å–¥–µ–ª–∞—Ç—å –∞–¥–∞–ø—Ç–∏–º–Ω—ã–º –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
–¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –Ω—É–∂–Ω–∞ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –Ω–æ –Ω–µ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö
hyde –≤–æ–æ–±—â–µ –≤—ã–∫–ª—é—á–∞–µ–º –æ–Ω –º–µ—à–∞–µ—Ç
5) –ø—Ä–æ–º–ø—Ç—ã –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ –∏ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º–∏ –±–µ–∑ –≤–≤—Å—è–∫–æ–π –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏ –∫–∞–∫ —Å–µ–π—á–∞—Å –≤–æ–∑–º–æ–∂–Ω–æ
–Ω–µ –∑–Ω–∞—é –∫–∞–∫ –Ω–∞—É—á–∏—Ç—å —Ä–∞–∑–ª–∏—á–∞—Ç—å, –Ω–∞–≤–µ—Ä–Ω–æ–µ LLM —Å–∞–º–∞ —Ä–∞–∑–ª–∏—á–∞–µ—Ç –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º
6) –ª–æ–∫–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ—â–Ω–µ–π—à–µ–µ, –∞ —Ç–æ —á—Ç–æ —Ç—Ä–∞—Ç–∏—Ç —Ç–æ–∫–µ–Ω—ã - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –≤—ã—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ —Å—Ç—Ä–µ–º–∏–º—Å—è –∫ –∫–∞—á–µ—Å—Ç—É —á—Ç–æ–±—ã –Ω–µ–±—ã–ª–æ –≤–∑—Ä—ã–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤
—Å—Ç—Ä–∏–º–∏–Ω–≥ –Ω–µ –æ—Å–æ–±–æ –∫—Ä–∏—Ç–∏—á–µ–Ω, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ–≥–æ –ª–µ–≥–∫–æ –≤–Ω–µ–¥—Ä–∏—Ç—å



–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:
    1. Anthropic –∫—ç—à–∏—Ä—É–µ—Ç –ü–†–ï–§–ò–ö–° –ø—Ä–æ–º–ø—Ç–∞ (–Ω–∞—á–∞–ª–æ)
    2. –ö—ç—à –∂–∏–≤–µ—Ç 5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    3. –ù—É–∂–Ω–æ –ø–æ–º–µ—á–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –∏—Å—Ç–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ cache_control
    4. –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ü–û–°–õ–ï –∫—ç—à–∏—Ä—É–µ–º–æ–π —á–∞—Å—Ç–∏
    """

–Ø —Ö–æ—á—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –ø–æ–¥—Å—É–Ω—É—Ç—å –µ–º—É –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—É—é –∫–∞—Ä—Ç—É –∫–æ—Ç–æ—Ä—É—é —è —Å–∞–º —Å–æ—Å—Ç–∞–≤–ª—é –∏ –ø–æ–ª–æ–∂—É –≤ –≤–∏–¥–µ –ø—Ä–æ–º–ø—Ç–∞,
 –∞ –∑–∞—Ç–µ–º –ø–æ–¥–æ–∂–¥–∞—Ç—å –æ—Ç –Ω–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏ –≤ –æ—Ç–≤–µ—Ç–µ —è —Ö–æ—á—É —á—Ç–æ–±—ã –æ–Ω —É–∫–∞–∑–∞–ª —á—Ç–æ –∏–∑ —Å–∏—Å—Ç–µ–º—ã –µ–º—É —Ç—Ä—É–±–µ—Ç—Å—è –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞.
 –ó–∞—Ç–µ–º —Ç–æ —á—Ç–æ –æ–Ω —Å–∫–∞–∂–µ—Ç —è –≤—ã–Ω—É –∏ —ç—Ç–æ –º–æ–π question –≤ —Å–∏—Å—Ç–µ–º—É –≤—ã–Ω–∏–º–∞–Ω–∏—è —á–∞–Ω–∫–æ–≤, –∑–∞—Ç–µ–º –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –ø–æ–∫–∞ –æ–Ω –Ω–µ –¥–∞—Å—Ç –æ—Ç–≤–µ—Ç.



 –í—Ä—É—á–Ω—É—é —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∫–∞—Ä—Ç–∞ –Ω–∞–≤–∞–∏–≥–∞—Ü–∏–∏ –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, –∫–ª–∞–¥—ë—Ç—Å—è –≤ –≤–∏–¥–µ txt —Ñ–∞–π–ª–∞ –∫–æ—Ç–æ—Ä—ã–π –¥–∞–ª–µ–µ –≤—Å—Ç–∞–≤–ª–µ—Ç—Å—è –≤–Ω—É—Ç—Ä—å prompt-–∞ –∫–æ—Ç–æ—Ä—ã–π 1 —Ä–∞–∑ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –¥–∏–∞–ª–æ–≥–µ –≤ —Å–µ—Å—Å–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å LLM –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω 1 —Ä–∞–∑. –í —ç—Ç–æ–º –ø—Ä–æ–º–ø—Ç–µ –±—É–¥–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –æ —Ç–æ–º –∫–∞–∫ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å: –¥–∞–ª–µ–µ LLM –¥–æ–ª–∂–Ω–∞ –±—É–¥–µ—Ç:
–õ–∏–±–æ 1) –¥–∞—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç, –∏ –ø–æ–¥–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥
–ª–∏–±–æ 2) –°–∫–∞–∑–∞—Ç—å —á—Ç–æ –æ–Ω–∞ —Å–µ–π—á–∞—Å –ø–æ–Ω–∏–º–∞–µ—Ç –∏ —Å–∫–∞–∑–∞—Ç—å —á—Ç–æ –µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∑–Ω–∞—Ç—å –µ—â—ë –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –∏ –∑–∞–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –±–ª–æ–∫–µ –≤–æ–ø—Ä–æ—Å–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã–π –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ —Å–∏—Å—Ç–µ–º–µ (–≤ –¥–∞–ª—å–Ω–µ–π—à–µ–µ–º –º–æ–∂–Ω–æ –Ω–∞—É—á–∏—Ç—å –µ—ë –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å —á–∞–Ω–∫–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ñ–∞–π–ª–∞ –∏ –Ω–æ–º–µ—Ä—É –∏–ª–∏ –¥–µ–ª–∞—Ç—å grep –ø–æ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ.

–§–∏—á–∞ - –ï—â—ë –≤–∞–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –∑–∞–ø—Ä–æ—Å–∞ –∫ —Ä–µ—Ç—Ä–∏–≤–µ—Ä—É –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É –ø—É—Ç–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π. –í–∞–∂–Ω–æ —á—Ç–æ–±—ã –±—ã–ª–æ —Ä–æ–≤–Ω–æ 1 —Ç–∞–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ / - –∫–æ—Ä–µ–Ω—å /folder1/folder2 –∏—Ç–ø, –Ω—É–∂–Ω–æ –æ–±—ä—è—Å–Ω–∏—Ç—å LLM —á—Ç–æ —á–µ–º —Å–∏–ª—å–µ–Ω–π –æ–Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç —Ç–µ–º –º–µ–Ω—å—à–µ –ø–æ–ø–∞–¥—ë—Ç.  –ò–∑ –∫–æ—Ä–Ω—è –ø–æ–ø–∞–¥—ë—Ç –≤—Å—ë. –¢–∞–∫–∏–º –º–µ—Ç–æ–¥–æ–º –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –≤–ø–ª–æ—Ç—å –¥–æ 1 —Ñ–∞–π–ª–∞.

–§–∏—á–∞ - –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Ç–æ–¥ - —Ç–∞–∫–∏—Ö –ø—É—Ç–µ–π –º–æ–∂–µ—Ç –±—ã—Ç—å –º–Ω–æ–≥–æ –∏ –≤—ã–≥–ª—è–¥—è—Ç –æ–Ω–∏ —Ñ–æ—Ä–º–∞—Ç–∞
–ø—É—Ç—å - —Ä–µ–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å + –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
–ø—É—Ç—å - —Ä–µ–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å + –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
–ø—É—Ç—å - —Ä–µ–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å + –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞

–õ–∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤ –Ω–∞ –≤—Å–µ —ç—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã –Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ —É–º–Ω–æ–º—É - –Ω–∞–ø—Ä–∏–º–µ—Ä –ø–æ–∑–≤–æ–ª–∏—Ç—å LLM –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –±–æ–ª—å—à–µ –Ω–æ —Ç–æ–≥–¥–∞ –±—É–¥–µ—Ç –Ω–µ –º–µ–Ω–µ–µ 2-3 —á–∞–Ω–∫–æ–≤ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É, –Ω–æ –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ—Ç LLM –º–∞–ª–æ - —Ç–æ–≥–¥–∞ –±–æ–ª—å—à–µ —á–∞–Ω–∫–æ–≤ –Ω–∞–ø—Ä–∏–º–µ—Ä 10 –Ω–∞ –∫–∂–∞–¥—ã–π –æ—Ç–≤–µ—Ç

–§–∏—á–∞ - –≤ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –∫–∞–∂–¥—ã–π —Ç–∞–∫–æ–π –ø—É—Ç—å –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å grep –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å –∫ –æ—Ç–≤–µ—Ç—É –≥–¥–µ –≤–æ–æ–±—â–µ –≤ —Å–∏—Å—Ç–µ–º–µ —Ç–∞–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è (—ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –µ—ë –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)

–î–∞–ª–µ–µ –≤—Å–µ –æ—Ç–≤–µ—Ç—ã-–≤–æ–ø—Ä–æ—Å—ã –ø–æ–ø–∞–¥–∞—é—Ç –≤ –∫—ç—à –∫–∞–∫ –∏—Å—Ç–æ—Ä–∏—è—è —á—Ç–æ–±—ã LLM –∏—Ö –ø–æ–º–Ω–∏–ª–∞

–§–∏—á–∞ - –¥–µ–¥—É–ø —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —á–∞–Ω–∫–æ–≤ - –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å –∏—Ö –ø—Ä–∏ —Ä–µ—Ç—Ä–∏–≤–µ ref_doc_id#chunk
–§–∏—á–∞ - —Å–∂–∏–º–∞—Ç—å —Ö–≤–æ—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–∞–∫ —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—É–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç


–ö–æ—Ä–æ—Ç–∫–æ: –∫—ç—à —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—Ö–æ–¥–Ω—ã—Ö –±–ª–æ–∫–æ–≤, –∞ –Ω–µ ‚Äú–ø–∞–º—è—Ç–∏‚Äù –¥–∏–∞–ª–æ–≥–∞.
–û–Ω –∫–µ—à–∏—Ä—É–µ—Ç –≤—Ö–æ–¥ (system-–ø—Ä–æ–º–ø—Ç, –¥–ª–∏–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∫–æ–Ω—Ç–µ–∫—Å—Ç), –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–∏—Å—ã–ª–∞–µ—à—å –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ç–µ–º –∂–µ —Ç–µ–∫—Å—Ç–æ–º –∏ —Å cache_control ‚Äî —Ç–æ–≥–¥–∞ –±–∏–ª–ª–∏–Ω–≥/–ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∑–∞ —ç—Ç–∏ —Ç–æ–∫–µ–Ω—ã —Å–Ω–∏–∂–∞—é—Ç—Å—è.
–û—Ç–≤–µ—Ç—ã –º–æ–¥–µ–ª–∏ –∏ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–∞–º –ø–æ —Å–µ–±–µ –∫—ç—à –Ω–µ ‚Äú–∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç‚Äù. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã –ø—Ä–æ—à–ª—ã–µ —Ä–µ–ø–ª–∏–∫–∏ –≤–ª–∏—è–ª–∏ –Ω–∞ –Ω–æ–≤—É—é ‚Äî —Ç—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–æ–ª–∂–µ–Ω –∏—Ö –ø—Ä–∏—Å–ª–∞—Ç—å —Å–Ω–æ–≤–∞ (–∏ –∏—Ö –º–æ–∂–Ω–æ –ø–æ–º–µ—Ç–∏—Ç—å –¥–ª—è –∫—ç—à–∞, –µ—Å–ª–∏ –æ–Ω–∏ –±–æ–ª—å—à–∏–µ –∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –±—É–∫–≤–∞–ª—å–Ω–æ).
–õ—é–±–∞—è –º–µ–ª–∫–∞—è –ø—Ä–∞–≤–∫–∞ –≤ –∫–µ—à–∏—Ä—É–µ–º–æ–º –±–ª–æ–∫–µ = –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç ‚áí –ø—Ä–æ–º–∞—Ö –∫—ç—à–∞.
–ò—Å–ø–æ–ª—å–∑—É–π –∫—ç—à –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤: SYSTEM_PROMPT, ‚Äú–Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞‚Äù, —á–∞—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã–µ —Å–ø—Ä–∞–≤–∫–∏. –ù–µ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª–∞ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–µ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã/–æ—Ç–≤–µ—Ç—ã.


def build_messages(history, system_text, nav_map, last_user_msg):
    msgs = []
    # 1) —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã ‚Äî –≤—Å–µ–≥–¥–∞ –∫—ç—à–∏—Ä—É–µ–º
    msgs.append({"role":"user","content":[
        {"type":"text","text":system_text,"cache_control":{"type":"ephemeral"}},
        {"type":"text","text":"–ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞:","cache_control":{"type":"ephemeral"}},
        {"type":"text","text":nav_map,"cache_control":{"type":"ephemeral"}},
    ]})
    # 2) ¬´–∑–∞–º—ë—Ä–∑—à–∞—è¬ª –∏—Å—Ç–æ—Ä–∏—è (–≤—Å—ë, –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) ‚Äî –∫—ç—à–∏—Ä—É–µ–º –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
    for u, a in history[:-1]:  # history: List[Tuple[user_text, assistant_text]]
        if u:
            msgs.append({"role":"user","content":[{"type":"text","text":u,"cache_control":{"type":"ephemeral"}}]})
        if a:
            msgs.append({"role":"assistant","content":[{"type":"text","text":a,"cache_control":{"type":"ephemeral"}}]})
    # 3) —Ç–µ–∫—É—â–∏–π —Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –±–µ–∑ –∫—ç—à–∞
    msgs.append({"role":"user","content":[{"type":"text","text":last_user_msg}]})
    return msgs


üîç –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ
Anthropic –∫—ç—à–∏—Ä—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫—É—Å–∫–∏ —Ç–µ–∫—Å—Ç–∞ (–±–ª–æ–∫–∏ {"type": "text", "text": "...", "cache_control": {"type": "ephemeral"}}).
–ö–∞–∂–¥—ã–π —Ç–∞–∫–æ–π –±–ª–æ–∫ –∏–º–µ–µ—Ç —Å–≤–æ–π —Ö—ç—à-–∫–ª—é—á, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –µ–≥–æ —Ç–µ–∫—Å—Ç–µ.
–ö–æ–≥–¥–∞ —Ç—ã –ø–æ—Å—ã–ª–∞–µ—à—å –∑–∞–ø—Ä–æ—Å:
–º–æ–¥–µ–ª—å –≤—ã—á–∏—Å–ª—è–µ—Ç —Ö—ç—à –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞;
–µ—Å–ª–∏ —ç—Ç–æ—Ç —Ö—ç—à —É–∂–µ –µ—Å—Ç—å –≤ –∫—ç—à–µ ‚Üí –±–ª–æ–∫ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è (—Ö–∏—Ç);
–µ—Å–ª–∏ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å (–Ω–æ–≤—ã–π –∫—ç—à-–∫–ª—é—á).




# 1. –û–±—ä—è–≤–ª—è–µ—à—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ö–ª–æ–¥–∞
tools = [
    {
        "name": "search_code",
        "description": "–ù–∞–π—Ç–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —á–∞—Å—Ç–∏ –∫–æ–¥–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É",
        "parameters": {
            "query": "str",
            "file_paths": "list[str] | null"  # –¢–≤–æ—è —Ñ–∏—á–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø—É—Ç–µ–π!
        }
    },
    {
        "name": "get_conversation_history",
        "description": "–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ–±—Å—É–∂–¥–µ–Ω–∏—è",
        "parameters": {}
    }
]

# 2. –ö–ª–æ–¥ –°–ê–ú —Ä–µ—à–∞–µ—Ç, –∫–æ–≥–¥–∞ —á—Ç–æ –≤—ã–∑—ã–≤–∞—Ç—å
response = claude.messages.create(
    model="claude-3-sonnet",
    messages=[{"role": "user", "content": "–ù–∞–π–¥–∏ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞"}],
    tools=tools
)

# 3. –ö–ª–æ–¥ –º–æ–∂–µ—Ç —Å–∫–∞–∑–∞—Ç—å: "–•–æ—á—É –≤—ã–∑–≤–∞—Ç—å search_code —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏..."



–¥–∞ —è —Å–∞–º –±—É–¥—É —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—Ç—è–Ω–∫—É –∏ –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä–æ–µ –ø—Ä–æ—Å—Ç–æ –º–Ω–µ –Ω–∞–¥–æ —á—Ç–æ–±—ã –ö–ª–æ–¥ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª
—Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –º–æ–µ–≥–æ –∫–æ–¥–∞ —Ä–∞–∑–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º –∏ –º–Ω–µ —Ö–æ—á–µ—Ç—Å—è —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ tools –Ω–æ —è –∫–æ–≥–¥–∞ –≤—ã—Ç—è–Ω—É –¥–ª—è –Ω–µ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∏
—Å—Ñ–æ—Ä–º–∏—Ä—É—é –¥–ª—è –Ω–µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç —è –ø—Ä–∏–π–µ–ø–ª—é –≤—Å—é —Å—Ç–∞—Ä—É—é –∏—Å—Ç–æ—Ä–∏—é –ø–ª—é—Å –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å—á—è



–í–∞–∂–Ω–æ –≤—Å—ë –¥–µ–ª–∞—Ç—å –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ —Å—Ç–∏–ª—è –±–µ–∑ –∏–∑–ª–∏—à–µ—Å—Ç–≤, –±–µ–∑ –∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏
–ù–µ —Å—Ç–∞–≤—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –Ω–µ –¥–µ–ª–∞–π –ª–∏—à–Ω–∏—Ö –ø–µ—Ä–µ–≤–æ–¥–æ–≤ —Å—Ç—Ä–æ–∫ (–Ω–æ –∏ –Ω–µ –¥–µ–ª–∞–π –ª–∏–∞–Ω—ã –Ω–µ –ª–æ–º–∞–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ),
–Ω–µ —Å–æ–∫—Ä–∞—â–∞–π –Ω–∞–∑–≤–∞–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã


–≥—Ä–∞—Ñ –≤—â–∞–∏–º–æ—Å–≤—è–∑–µ–π —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π. tool


–Ω–∞—É—á–Ω–∏—Ç—å LLM –µ—â—ë –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ –Ω–æ–º–µ—Ä–∞–º —Å—Ç—Ä–æ–∫ –∏ –≤–∏–¥–∏–º–æ —Ç–æ–≥–¥–∞ –Ω–∞–¥–æ –Ω–∞—á–∞–ª–æ —Å—Ç—Ä–æ–∫–∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤–º–µ—Å—Ç–µ —Å –ø—É—Ç—ë–º


docker compose down -v --remove-orphans && docker compose build --no-cache && docker compose up -d


–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –∑–∞–ø—Ä–æ—Å (kNN + BM25)
–í–æ—Ç –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π:
–º–µ—à–∞–µ—Ç kNN –∏ BM25,
–±—É—Å—Ç–∏—Ç —Ç–æ—á–Ω—ã–µ —Ñ—Ä–∞–∑—ã,
—Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä–µ—Ñ–∏–∫—Å-—Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ doc_id (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω path_prefix).
def _retrieve(self, query_bundle: QueryBundle) -> List[NodeWithScore]:
    q = query_bundle.query_str
    query_embedding = Settings.embed_model.get_text_embedding(q)

    body = {
        "size": self.top_k,
        "knn": {
            "field": "embedding",
            "query_vector": query_embedding,
            "k": self.top_k,
            "num_candidates": self.top_k * 5,
        },
        "query": {
            "bool": {
                "minimum_should_match": 0,
                "should": [
                    {  # –æ–±—â–∏–π BM25 –ø–æ –±–∞–∑–æ–≤–æ–º—É –ø–æ–ª—é
                        "match": {
                            "text": {
                                "query": q,
                                "boost": 1.0
                            }
                        }
                    },
                    {  # –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–π multi_match (–ø–æ–ª—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –º—ç–ø–ø–∏–Ω–≥–µ)
                        "multi_match": {
                            "query": q,
                            "fields": [
                                "text^1.0",
                                "text.ru^1.3",
                                "text.en^1.2"
                            ],
                            "type": "best_fields"
                        }
                    },
                    {  # —Ç–æ—á–Ω—ã–µ —Ñ—Ä–∞–∑—ã ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–π –±—É—Å—Ç
                        "match_phrase": {
                            "text": {
                                "query": q,
                                "slop": 2,
                                "boost": 0.5
                            }
                        }
                    }
                ]
            }
        }
    }

    # –ü—Ä–µ—Ñ–∏–∫—Å-—Ñ–∏–ª—å—Ç—Ä –ø–æ –ø—É—Ç–∏ (–∏ –≤ query.bool.filter, –∏ –≤ knn.filter)
    if self.path_prefix:
        prefix_filter = {"prefix": {"doc_id": self.path_prefix}}
        body["query"]["bool"].setdefault("filter", []).append(prefix_filter)
        body["knn"]["filter"] = prefix_filter

    resp = self.es.search(
        index=self.index,
        knn=body["knn"],
        query=body["query"],
        size=body["size"],
        request_timeout=30
    )

    nodes = []
    for hit in resp["hits"]["hits"]:
        src = hit["_source"]
        # –í–∞–∂–Ω–æ: —Ä–∞—Å–ø–ª—é—â–∏–≤–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, —Ç.–∫. chunk-–ø–æ–ª—è –ª–µ–∂–∞—Ç –≤ metadata
        flat_meta = {"doc_id": src.get("doc_id")}
        flat_meta.update((src.get("metadata") or {}))
        node = TextNode(id_=hit["_id"], text=src["text"], metadata=flat_meta)
        nodes.append(NodeWithScore(node=node, score=float(hit["_score"])))
    return nodes
–ò—Ç–æ–≥
–° —Ç–≤–æ–∏–º –∏–Ω–¥–µ–∫—Å–æ–º multi_match –ø–æ text, text.ru, text.en ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.
–ü—Ä–æ–≤–µ—Ä—å —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (== 1024).
–í ru_text –ª—É—á—à–µ —É–±—Ä–∞—Ç—å ¬´–≥–æ–ª—ã–π¬ª stop.
–ù–µ –∑–∞–±—É–¥—å ¬´—Ä–∞—Å–ø–ª—é—â–∏–≤–∞—Ç—å¬ª metadata –ø—Ä–∏ —Å–±–æ—Ä–∫–µ TextNode, —á—Ç–æ–±—ã nodes_to_text –Ω–µ –ø–∞–¥–∞–ª –Ω–∞ –∫–ª—é—á–∞—Ö chunk_id/start_line/....
–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–≥—É –¥–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π JSON –¥–ª—è PUT /<index> —Å –æ–±–ª–µ–≥—á—ë–Ω–Ω—ã–º ru_text –∏ –∫—Ä–∞—Ç–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π —á–µ—Ä–µ–∑ _analyze.






–ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç: –¥–∞, –≤ Anthropic Prompt Caching –º–æ–∂–Ω–æ ¬´—á–∏—Ç–∞—Ç—å –∏–∑ –∫—ç—à–∞¬ª –º–∞–∫—Å–∏–º—É–º 4 text-–±–ª–æ–∫–∞ –∑–∞ –æ–¥–∏–Ω –≤—ã–∑–æ–≤. –≠—Ç–æ –Ω–µ –º–µ—à–∞–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ –¥—Ä—É–≥–∏—Ö –±–ª–æ–∫–æ–≤ ‚Äî –ø—Ä–æ—Å—Ç–æ –±–µ–Ω–µ—Ñ–∏—Ç –∫—ç—à–∞ –±—É–¥–µ—Ç –º–∞–∫—Å–∏–º—É–º –Ω–∞ —á–µ—Ç—ã—Ä—ë—Ö. –ü–æ—ç—Ç–æ–º—É —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–∞–∫–∞—è: —Å–¥–µ–ª–∞—Ç—å 4 ¬´–∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö¬ª (stable) –±–ª–æ–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–¥–∫–æ –º–µ–Ω—è—é—Ç—Å—è –∏ –≤—Å–µ–≥–¥–∞ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –∫—ç—à, –∞ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –¥–∞–≤–∞—Ç—å ¬´—Å–∫–æ–ª—å–∑—è—â–∏–º –æ–∫–Ω–æ–º¬ª –±–µ–∑ –∫—ç—à–∞.
–í–æ—Ç —Ä–∞–±–æ—á–∏–π —Ä–µ—Ü–µ–ø—Ç, —á—Ç–æ–±—ã –∏ —ç–∫–æ–Ω–æ–º–∏—Ç—å, –∏ —á—Ç–æ–±—ã –º–æ–¥–µ–ª—å ¬´–ø–æ–º–Ω–∏–ª–∞¬ª —Å—É—Ç—å –¥–∏–∞–ª–æ–≥–∞.
–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å (4 —Å–ª–æ—Ç–∞)
System prompt ‚Äî –≤—Å–µ–≥–¥–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–º text-–±–ª–æ–∫–æ–º —Å cache_control: {"type":"ephemeral"} (–≤—ã —É–∂–µ –¥–µ–ª–∞–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ).
Running summary (—Å–∂–∞—Ç–∞—è –∫–∞–Ω–≤–∞ –¥–∏–∞–ª–æ–≥–∞) ‚Äî –æ–¥–∏–Ω –∫–æ—Ä–æ—Ç–∫–∏–π text-–±–ª–æ–∫ —Å —É—Å—Ç–æ–π—á–∏–≤–æ–π –≤—ã–∂–∏–º–∫–æ–π: —Ü–µ–ª—å, —Ñ–∞–∫—Ç—ã, –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏, –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏. –û–±–Ω–æ–≤–ª—è—Ç—å —Ä–µ–¥–∫–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑ –≤ 3‚Äì5 —Ö–æ–¥–æ–≤ –∏–ª–∏ –ø—Ä–∏ ¬´—Å–¥–≤–∏–≥–µ —Å—é–∂–µ—Ç–∞¬ª).
User/Project profile (—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è) ‚Äî —Å–ª–µ–ø–æ–∫ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π/–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞. –ü–æ—á—Ç–∏ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.
Stable domain context ‚Äî –µ—Å–ª–∏ —É –≤–∞—Å RAG –∏ –≤—ã –∫—Ä—É—Ç–∏—Ç–µ—Å—å –≤–æ–∫—Ä—É–≥ —Ç–µ—Ö –∂–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤/API-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤, –ø–æ–ª–æ–∂–∏—Ç–µ —Å—é–¥–∞ ¬´–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ¬ª –≤—ã–¥–µ—Ä–∂–∫–∏. –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —á–∞—Å—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è ‚Äî –ª—É—á—à–µ –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å —Å–ª–æ—Ç –∏ –æ—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ –ø—É—Å—Ç—ã–º.
–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏ –ø—Ä–æ–º–ø—Ç–∞ ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Ö–æ–¥–æ–≤ (—Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ) + –Ω–æ–≤—ã–µ query/chunks –∏–∑ RAG ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –±–µ–∑ cache_control. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ: –æ–Ω–∏ –º–µ–Ω—è—é—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫—ç—à –Ω–∞ –Ω–∏—Ö –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –¥–∞—Å—Ç –ø–æ–ª—å–∑—ã. 


–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–±—Ä–∞—Ç—å –∏–∑ docstring –ø—Ä–æ—Å—å–±—É —á–∏—Ç–∞—Ç—å LLM –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

Tool —Å–≤–æ–¥–∫–∏ –¥–∏–∞–ª–æ–≥–∞ summary –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤—Å–µ tool-use –∑–∞–∫–æ–Ω—á–µ–Ω—ã


–ù–µ –≥–æ–≤–æ—Ä–∏ —Å–∫–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω–æ–≤, –ª—É—á—à–µ –Ω–∞–ø–∏—à–∏ —á—Ç–æ–±—ã –Ω–µ –∑–∞–±—ã–ª –Ω–∏–∫–∞–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π
–ò —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è–ª –Ω—É–º–µ—Ä–∞—Ü–∏—é –ø—É–Ω–∫—Ç–æ–≤ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞–∫–∏–µ-—Ç–æ –Ω—É–º–µ—Ä–∞—Ü–∏–∏

–∏ –¥–∞–≤–∞–π –µ—â—ë —Å–¥–µ–ª–∞–µ–º —Ç–∞–∫ —á—Ç–æ–±—ã –æ–Ω —Ä–æ–≤–Ω–æ 1 —Ä–∞–∑ –º–æ–≥ –≤—ã–∑–≤–∞—Ç—å –ø–æ–¥–º–æ–≥—É –≤ –≤–∏–¥–µ —Ç—É–ª–æ–≤ –∏ –Ω–∏–∫–∞–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–∑–∂–µ –∏ –≤ –ø—Ä–æ–º–ø—Ç–µ –µ–º—É —ç—Ç–æ –æ–±—ä—è—Å–Ω–∏–º

–ò —Ç–µ–ø–µ—Ä—å –≤ chat.py –æ–≥—Ä–∞–Ω–∏—á–∏–º —Ä–æ–≤–Ω–æ 1 –∏—Ç–µ—Ä–∞—Ü–∏–µ–π



–ê –º–æ–∂–Ω–æ –º–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–∞—Ç—å 2 –ø—Ä–æ–º–ø—Ç–∞
1) –¥–ª—è —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
2) –¥–ª—è –ø–æ–¥–≤–µ–¥–µ–Ω–∏—è –∏—Ç–æ–≥–∞ –ø–æ —Å–æ–±—Ä–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏?


–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ + AST —Ñ–æ—Ä–º–∞—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å –¥–ª—è –ø—É—â–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞

–î–µ–ª–∞—Ç—å SUmmary –ø–æ—Ñ–∞–π–ª–æ–≤–æ –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º

–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–≤–µ–¥–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤